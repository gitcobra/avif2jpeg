(function(){"use strict";const w=new OffscreenCanvas(100,100),P=w.getContext("bitmaprenderer");let d;const M=new Map;self.onmessage=async l=>{const{ports:e}=l;if(e[0]){d=e[0],d.onmessage=R,self.postMessage({action:"respond-to-first-message"});return}const n=l.data;for(const t of n)await T(t);self.postMessage({action:"list-end"})};async function T(l){const{index:e,file:n,fileId:t,type:g,quality:m,demandThumbnail:h,isSingleImage:b,webkitRelativePath:u,maxSize:f}=l,o=u||n.webkitRelativePath||n.name,v=n.size;let s;s={action:"file-start",path:o,fileId:t,index:e},self.postMessage(s);let c,a,i,y=!1;try{if(c=await createImageBitmap(n),{width:a,height:i}=c,f){const r=a/i;let{width:x,height:k}=f,p=null;a>x&&(a=x,i=a/r,p={resizeWidth:a}),i>k&&(i=k,a=i*r,p={resizeHeight:i}),y=!!p,c=await createImageBitmap(c,{resizeQuality:"high",...p||{}})}}catch{s={action:"file-error",path:o,fileId:t,index:e},self.postMessage(s);return}let I=null;if(h){const r=a>i?{resizeWidth:110}:{resizeHeight:80};I=await createImageBitmap(c,{...r,resizeQuality:"low"})}P.transferFromImageBitmap(c),s={action:"file-load",fileId:t,path:o,index:e,thumbnail:I,width:a,height:i,shrinked:y},self.postMessage(s);let z;try{z=await w.convertToBlob({type:g,quality:m})}catch{s={action:"file-error",path:o,fileId:t,index:e},self.postMessage(s);return}const B=z.size;d.postMessage({blob:z,path:o,fileId:t}),s={action:"file-converted",path:o,fileId:t,index:e,outputsize:B,inputsize:v,width:a,height:i},self.postMessage(s),M.set(t,{outputsize:B,inputsize:v,path:o,index:e})}const R=l=>{const{fileId:e,renamed:n,outputPath:t,canceled:g}=l.data,{inputsize:m,outputsize:h,path:b,index:u}=M.get(e),f={action:g?"file-canceled":"file-completed",fileId:e,path:b,index:u,inputsize:m,outputsize:h};self.postMessage(f)}})();
