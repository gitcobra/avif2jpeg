var ve=Object.defineProperty;var ye=(u,i,m)=>i in u?ve(u,i,{enumerable:!0,configurable:!0,writable:!0,value:m}):u[i]=m;var L=(u,i,m)=>ye(u,typeof i!="symbol"?i+"":i,m);(function(){"use strict";function u(e){return new Worker("/avif2jpeg/dist/assets/worker.canvas-BFzUdO9A.js",{name:e==null?void 0:e.name})}let i=0;class m extends u{constructor(s){super();L(this,"id",i++);L(this,"priority");this.priority=s||!1}release(){b(this)}}class se extends Promise{constructor(){super(...arguments);L(this,"wid",-1)}}const T=new Set,k=new Set,p=new Set,I=new Map,U=[];function oe(e){const t=new m;return T.add(t),j(t,e),b(t),e&&U.push(t.id),t}function j(e,t){const s=t?p:k,r=new se(o=>{I.set(e,()=>o([e,r,!!t]))});r.wid=e.id,s.add(r)}async function re(e){let t;if(!e)t=new Set([...p,...k]);else if(typeof e=="number"){const n=U.slice(0,e);t=new Set([...p].filter(l=>n.includes(l.wid)))}else t=e?p:k;const[s,r,o]=await Promise.any(t);return(o?p:k).delete(r),j(s,o),s}function b(e){const t=I.get(e);t&&(I.delete(e),t(),g==null||g(),g=null)}function ne(){for(const e of I.keys())b(e)}async function G(){return await Promise.all([...k,...p])}let V,g=null;async function ae(){g||(V=new Promise(e=>g=e)),await V}function ie(){ne();for(const e of T)e.onmessage=null,e.terminate();T.clear(),k.clear(),p.clear(),I.clear(),i=0}function ce(e){return[...T].find(t=>t.id===e)}function le(e){return new Promise(t=>setTimeout(t,e))}const fe=1,X=2e3*2e3*5,de=5,ue=1,pe=X*6,we=100;let $,c;const v=new Map,Y=new Map,R=new Map;let y=0,_=!1,Z=0,q=0;self.onmessage=async e=>{const{data:t,ports:s}=e,{action:r}=t;switch(r){case"set-zip-port":{$=s[0],self.postMessage({action:"respond-to-first-message"});break}case"start-convert":{const{list:o,extraPropsForList:n,outputType:l,outputQuality:W,threads:x,maxSize:C,keepExt:E,outputExt:z,fsysDirHandler:J,existingFolders:D}=t;o.forEach((M,S)=>{M._id=n[S][0],M.webkitRelativePath||Object.defineProperty(M,"webkitRelativePath",{value:n[S][1]})}),me(o,l,W,x,z,E,C,J,D);break}case"cancel-convert":_=!0;break;case"respond-overwrite":{const o=t.workerId;ce(o).postMessage({action:"respond-overwrite",command:t.command,target:t.target,fileId:t.fileId,path:t.path});break}}};async function me(e,t,s,r,o,n,l,W,x){c=e;const C=Math.max(1,Math.min(r-3,c.length)),E=Math.min(de,C);ke(C,E,W,x);const z=async()=>{for(let f=1;!_&&y>pe;f++){if(f>9999)throw new Error(`maybe totalChunkSize is deadlocked :${y}`);await ae()}},D=c.length===1;let M=0,S="",a=0;for(;a<c.length;a++){const f=[];let F=!1;const he=c.length-a;Math.min(a+Math.max(Math.min(ue,he/r|0),1),c.length);let N=0,O=!1;const d=c[a],w=d._id,A=d.webkitRelativePath||d.name,Me=R.get(w);if(O=O||!!Me,F=a===c.length-1,Z++,h("file-start",a,A,w),_){h("file-canceled",a,A,w);continue}let P;try{P=await createImageBitmap(d)}catch{Q(a,A,w);continue}if(await z(),_){h("file-canceled",a,A,w);continue}f.push(P);const ee=P.width*P.height*4;N+=ee+d.size,y+=ee+d.size;let B=!1;const te=Date.now();te-M>we&&(M=te,B=!0);const Ie={index:a,bitmap:P,file:d,fileId:w,outputPath:S,type:t,quality:s/100,keepPrevExt:n,outputExt:o,demandThumbnail:B||F,isSingleImage:D,maxSize:l,retriedTime:R.get(w)||0,webkitRelativePath:d.webkitRelativePath.replace(/^\//,"")};B=!1;let H;const be=N>X;H=await re(E>0&&(O?1:be)),v.set(H.id,N),H.postMessage(Ie,f),f.length=0,F&&await G()}await G(),self.postMessage({action:"end-convert"});for(let f=0;Z!==q&&!(f>50);f++)await le(100);self.postMessage({action:"close-loader"}),self.close()}function ke(e,t,s,r){ie();for(let o=0;o<e;o++){const n=oe(t>o);n.onmessage=ge;const{port1:l,port2:W}=new MessageChannel;$.postMessage({action:"set-port-canvas"},[l]),n.postMessage({port:"zip",fsysDirHandler:s,existingFolders:r},[W])}}const ge=async e=>{const t=e.target,{data:s}=e,{action:r}=s;switch(r){case"file-load":s.workerId=t.id;case"file-canceled":{self.postMessage(s);break}case"file-converted":{const{convertedImageBlob:o,path:n}=s;self.postMessage(s);break}case"file-completed":case"file-sys-completed":{b(t),y-=v.get(t.id)||0,v.delete(t.id),self.postMessage(s);break}case"file-skip":case"file-error":{const{index:o,path:n,fileId:l}=s;b(t),y-=v.get(t.id)||0,v.delete(t.id),r==="file-error"?Q(o,n,l):h("file-skip",o,n,l);return}case"list-start":case"list-end":case"respond-to-first-message":break;case"confirm-overwrite":self.postMessage({...s,workerId:t.id});return}K(r)};function h(e,t,s,r){const o={action:e,index:t,path:s,fileId:r};self.postMessage(o),K(e)}function K(e){switch(e){case"file-completed":case"file-sys-completed":case"file-canceled":case"file-error":case"file-skip":case"file-retry":q++;break}}function Q(e,t,s){const r=c[e];if(!r)throw new Error(`the file doesn't exist. "${e}":"${t}"`);const o=Y.get(r._id)||0;o<fe?(Y.set(r._id,o+1),c.push(r),R.set(s,Date.now()),h("file-retry",e,t,s)):h("file-error",e,t,s)}})();
