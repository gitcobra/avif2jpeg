var pe=Object.defineProperty;var ge=(u,i,k)=>i in u?pe(u,i,{enumerable:!0,configurable:!0,writable:!0,value:k}):u[i]=k;var y=(u,i,k)=>ge(u,typeof i!="symbol"?i+"":i,k);(function(){"use strict";function u(e){return new Worker("/avif2jpeg/dist/assets/worker.canvas-DJWk42OT.js",{name:e==null?void 0:e.name})}let i=0;class k extends u{constructor(s){super();y(this,"id",i++);y(this,"priority");this.priority=s||!1}release(){T(this)}}class K extends Promise{constructor(){super(...arguments);y(this,"wid",-1)}}const C=new Set,h=new Set,m=new Set,g=new Map,x=[];function Q(e){const t=new k;return C.add(t),O(t,e),T(t),e&&x.push(t.id),t}function O(e,t){const s=t?m:h,n=new K(o=>{g.set(e,()=>o([e,n,!!t]))});n.wid=e.id,s.add(n)}async function ee(e){let t;if(!e)t=new Set([...m,...h]);else if(typeof e=="number"){const c=x.slice(0,e);t=new Set([...m].filter(f=>c.includes(f.wid)))}else t=e?m:h;const[s,n,o]=await Promise.any(t);return(o?m:h).delete(n),O(s,o),s}function T(e){const t=g.get(e);t&&(g.delete(e),t(),p==null||p(),p=null)}function te(){for(const e of g.keys())T(e)}async function H(){return await Promise.all([...h,...m])}let B,p=null;async function se(){p||(B=new Promise(e=>p=e)),await B}function ne(){te();for(const e of C)e.onmessage=null,e.terminate();C.clear(),h.clear(),m.clear(),g.clear(),i=0}function oe(e){return new Promise(t=>setTimeout(t,e))}const ae=1,G=2e3*2e3*5,ie=5,re=1,ce=G*6,le=100;let U,r;const P=new Map,V=new Map,S=new Map;let W=0,b=!1,X=0,$=0;self.onmessage=async e=>{const{data:t,ports:s}=e,{action:n}=t;switch(n){case"set-zip-port":{U=s[0],self.postMessage({action:"respond-to-first-message"});break}case"start-convert":{const{list:o,fileIdList:c,outputType:f,outputQuality:E,threads:Z,maxSize:L}=t;o.forEach((_,A)=>_._id=c[A]),fe(o,f,E,Z,L);break}case"cancel-convert":b=!0;break}};async function fe(e,t,s,n,o){r=e;const c=Math.max(1,Math.min(n-3,r.length)),f=Math.min(ie,c);de(c,f);const E=async()=>{for(let l=1;!b&&W>ce;l++){if(l>9999)throw new Error(`maybe totalChunkSize is deadlocked :${W}`);await se()}},L=r.length===1;let _=0,A="",a=0;for(;a<r.length;a++){const l=[];let D=!1;const me=r.length-a;Math.min(a+Math.max(Math.min(re,me/n|0),1),r.length);let R=0,z=!1;const d=r[a],w=d._id,v=d.webkitRelativePath||d.name,we=S.get(w);if(z=z||!!we,D=a===r.length-1,X++,M("file-start",a,v,w),b){M("file-canceled",a,v,w);continue}let I;try{I=await createImageBitmap(d)}catch{Y(a,v,w);continue}if(await E(),b){M("file-canceled",a,v,w);continue}l.push(I);const q=I.width*I.height*4;R+=q+d.size,W+=q+d.size;let N=!1;const J=Date.now();J-_>le&&(_=J,N=!0);const ke={index:a,bitmap:I,file:d,fileId:w,outputPath:A,type:t,quality:s/100,demandThumbnail:N||D,isSingleImage:L,maxSize:o,retriedTime:S.get(w)||0,webkitRelativePath:d.webkitRelativePath};N=!1;let F;const he=R>G;F=await ee(f>0&&(z?1:he)),P.set(F.id,R),F.postMessage(ke,l),l.length=0,D&&await H()}await H(),self.postMessage({action:"end-convert"});for(let l=0;X!==$&&!(l>50);l++)await oe(100);self.postMessage({action:"close-loader"}),self.close()}function de(e,t){ne();for(let s=0;s<e;s++){const n=Q(t>s);n.onmessage=ue;const{port1:o,port2:c}=new MessageChannel;U.postMessage({action:"set-port-canvas"},[o]),n.postMessage({},[c])}}const ue=e=>{const t=e.target,{data:s}=e,{action:n}=s;switch(n){case"file-load":s.workerId=t.id;case"file-converted":case"file-canceled":{self.postMessage(s);break}case"file-completed":{T(t),W-=P.get(t.id)||0,P.delete(t.id),self.postMessage(s);break}case"file-error":{const{index:o,path:c,fileId:f}=s;Y(o,c,f);break}}j(n)};function M(e,t,s,n){const o={action:e,index:t,path:s,fileId:n};self.postMessage(o),j(e)}function j(e){switch(e){case"file-completed":case"file-canceled":case"file-error":case"file-retry":$++;break}}function Y(e,t,s){const n=r[e];if(!n)throw new Error(`the file doesn't exist. "${e}":"${t}"`);const o=V.get(n._id)||0;o<ae?(V.set(n._id,o+1),r.push(n),S.set(s,Date.now()),M("file-retry",e,t,s)):M("file-error",e,t,s)}})();
