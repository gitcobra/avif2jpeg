(function(){"use strict";async function B(i,e,s,n,t){if(n!==!0)try{const a=await i.getFileHandle(e);if(!n||typeof n=="function"&&!await n(a,e,t))return!1}catch(a){if(a.name!=="NotFoundError")throw a}const o=await(await i.getFileHandle(e,{create:!0})).createWritable();return await o.write(s),await o.close(),!0}async function $(i,e,s,n){const t=s===!0;let r;try{if(r=await i.getDirectoryHandle(e,{create:t}),t)return r;if(!s||typeof s=="function"&&!await s(i,e,n))return null}catch(o){if(o.name==="NotFoundError")r=await i.getDirectoryHandle(e,{create:!0});else throw o}return r}async function R(i,e,s){const n=[];let t=i,r;const o=e instanceof Array?e.concat():String(e).split("/");r=o.join("/");do n.unshift(o.pop()),r=o.join("/");while(o.length);for(const a of n){if(!a)throw new Error("folderName is empty");if(t=await $(t,a,s,r),!t)return null;r+=a+"/"}return t}async function C(i,e,s,n){const t=e.split("/"),r=t.pop();if(!r)throw new Error("fileName is empty");const o=t.length?await R(i,t,n):i;return o?await B(o,r,s,n,t.length?t.join("/")+"/":"afo"):!1}function N(i,e){const s=e.replace(/^\s*\/?|\/?\s*$/g,"").split("/");do{const n=s.join("/");if(i.has(n))return;i.add(n),s.pop()}while(s.length)}function T(i,e,s){return s||(i=i.replace(/\.(jpe?g|jfif|pjpeg|pjp|gif|png|avif|webp|bmp|apng|ico)$/i,"")),i+"."+e}const p=new OffscreenCanvas(100,100),L=p.getContext("bitmaprenderer");let x,m,H;const S=new Map,Q=new Set,q=new Set,z=new Map;let w;self.onmessage=async i=>{const e=i.data;if("port"in e){const{ports:s}=i;if(s[0]){const{port:n,fsysDirHandler:t,existingFolders:r}=e;switch(m=m||t,H=r,n){case"zip":x=s[0],x.onmessage=G,self.postMessage({action:"respond-to-first-message"}),w=void 0;break;default:throw new Error(`unexptected port type ${n}`)}}return}if("action"in e){const{action:s,command:n,fileId:t,path:r,target:o}=e;switch(s){case"respond-overwrite":const a=z.get(r);if(!a)throw new Error(`no resolver exists for overwrite confirmation "${r}"`);z.delete(r),a(n);break}return}await Z(e),self.postMessage({action:"list-end"}),p.width=1,p.height=1};async function Z(i){const{index:e,file:s,bitmap:n,fileId:t,type:r,quality:o,demandThumbnail:a,isSingleImage:D,webkitRelativePath:g,maxSize:h,keepPrevExt:K,outputExt:U}=i,l=g||s.webkitRelativePath||s.name,F=s.size;let I=0,j=0,f,u,d,M,P,A=!1;try{if(f=n,{width:u,height:d}=f,I=M=u,j=P=d,h){const c=u/d;let{width:b,height:E}=h,v=null;u>b&&(u=b,d=u/c,v={resizeWidth:u}),d>E&&(d=E,u=d*c,v={resizeHeight:d}),A=!!v,f=await createImageBitmap(f,{resizeQuality:"high",...v||{}}),M=f.width,P=f.height,n.close()}}catch{self.postMessage({action:"file-error",path:l,fileId:t,index:e});return}let W;if(a){const c=u>d?{resizeWidth:110}:{resizeHeight:80};W=await createImageBitmap(f,{...c,resizeQuality:"low"})}L.transferFromImageBitmap(f),f.close(),self.postMessage({action:"file-load",fileId:t,path:l,index:e,thumbnail:W,width:I,height:j,inputsize:F});let y;try{y=await p.convertToBlob({type:r,quality:o})}catch{self.postMessage({action:"file-error",path:l,fileId:t,index:e});return}const k=y.size;if(p.width=1,p.height=1,self.postMessage({action:"file-converted",path:l,fileId:t,index:e,outputsize:k,outputWidth:M,outputHeight:P,shrinked:A}),S.set(t,{outputsize:k,inputsize:F,path:l,index:e}),m){const c=T(l,U,K),b=typeof w=="boolean"?w:J(c,t,e);try{await C(m,c,y,b)?(N(Q,c),self.postMessage({action:"file-sys-completed",fileId:t,path:l,index:e,inputsize:F,outputsize:k,entireIndex:e,storedPath:c})):self.postMessage({action:"file-skip",fileId:t,path:l,index:e})}catch{self.postMessage({action:"file-error",fileId:t,path:l,index:e})}}else x.postMessage({blob:y,path:l,fileId:t})}const G=i=>{const{fileId:e,renamed:s,outputPath:n,canceled:t,entireIndex:r,storedPath:o}=i.data,{inputsize:a,outputsize:D,path:g,index:h}=S.get(e);self.postMessage({action:t?"file-canceled":"file-completed",fileId:e,path:g,index:h,inputsize:a,outputsize:D,entireIndex:r,storedPath:o})};function J(i,e,s){return async(n,t,r)=>{const o=n instanceof FileSystemFileHandle,a=r+t;if(!o&&!H.has(a))return!0;switch(await new Promise(g=>{self.postMessage({action:"confirm-overwrite",type:o?"file":"folder",target:r+t,path:i,fileId:e,index:s}),z.set(i,h=>{g(h)})})){case"overwrite-all":w=!0;case"overwrite":return!0;case"skip-all":w=!1;case"close":case"cancel":case"skip":return q.add(i),!1;default:throw new Error("unexpected OverwriteCommand command")}}}})();
