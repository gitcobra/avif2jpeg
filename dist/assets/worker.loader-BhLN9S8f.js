var pe=Object.defineProperty;var ge=(u,i,k)=>i in u?pe(u,i,{enumerable:!0,configurable:!0,writable:!0,value:k}):u[i]=k;var y=(u,i,k)=>ge(u,typeof i!="symbol"?i+"":i,k);(function(){"use strict";function u(e){return new Worker("/avif2jpeg/dist/assets/worker.canvas-tWM4qNw1.js",{name:e==null?void 0:e.name})}let i=0;class k extends u{constructor(s){super();y(this,"id",i++);y(this,"priority");this.priority=s||!1}release(){b(this)}}class Q extends Promise{constructor(){super(...arguments);y(this,"wid",-1)}}const C=new Set,h=new Set,w=new Set,M=new Map,H=[];function J(e){const t=new k;return C.add(t),O(t,e),b(t),e&&H.push(t.id),t}function O(e,t){const s=t?w:h,n=new Q(o=>{M.set(e,()=>o([e,n,!!t]))});n.wid=e.id,s.add(n)}async function ee(e){let t;if(!e)t=new Set([...w,...h]);else if(typeof e=="number"){const c=H.slice(0,e);t=new Set([...w].filter(d=>c.includes(d.wid)))}else t=e?w:h;const[s,n,o]=await Promise.any(t);return(o?w:h).delete(n),O(s,o),s}function b(e){const t=M.get(e);t&&(M.delete(e),t(),p==null||p(),p=null)}function te(){for(const e of M.keys())b(e)}async function U(){return await Promise.all([...h,...w])}let B,p=null;async function se(){p||(B=new Promise(e=>p=e)),await B}function ne(){te();for(const e of C)e.onmessage=null,e.terminate();C.clear(),h.clear(),w.clear(),M.clear(),i=0}function oe(e){return new Promise(t=>setTimeout(t,e))}const ae=1,L=2e3*2e3*5,ie=5,re=1,ce=L*1,le=L*6,fe=100;let G,r;const P=new Map,V=new Map,E=new Map;let W=0,g=!1,X=0,Z=0;self.onmessage=async e=>{const{data:t,ports:s}=e,{action:n}=t;switch(n){case"set-zip-port":{G=s[0],self.postMessage({action:"respond-to-first-message"});break}case"start-convert":{const{list:o,fileIdList:c,outputType:d,outputQuality:q,threads:A}=t;o.forEach((_,N)=>_._id=c[N]),de(o,d,q,A);break}case"cancel-convert":g=!0;break}};async function de(e,t,s,n){r=e;const o=Math.max(1,Math.min(n-3,r.length)),c=Math.min(ie,o);ue(o,c);const d=async()=>{for(let f=1;!g&&W>le;f++){if(f>9999)throw new Error(`maybe totalChunkSize is deadlocked :${W}`);await se()}},A=r.length===1;let _=0,N="",a=0;for(;a<r.length;){const f=[],D=[];let R=!1;const me=r.length-a,ke=Math.min(a+Math.max(Math.min(re,me/n|0),1),r.length);let v=0,z=!1;for(;a<ke;a++){if(v>ce&&!g){await d();break}const l=r[a],m=l._id,S=l.webkitRelativePath||l.name,he=E.get(m);if(z=z||!!he,R=a===r.length-1,X++,I("file-start",a,S,m),g){I("file-canceled",a,S,m);continue}let T;try{T=await createImageBitmap(l)}catch{j(a,S,m);continue}if(await d(),g){I("file-canceled",a,S,m);continue}D.push(T);const K=T.width*T.height*4;v+=K+l.size,W+=K+l.size;let x=!1;const Y=Date.now();Y-_>fe&&(_=Y,x=!0),f.push({index:a,bitmap:T,file:l,fileId:m,outputPath:N,type:t,quality:s/100,demandThumbnail:x||R,isSingleImage:A,maxSize:null,retriedTime:E.get(m)||0,webkitRelativePath:l.webkitRelativePath}),x=!1}let F;if(f.length){const l=v>L;F=await ee(c>0&&(z?1:l)),P.set(F.id,v),F.postMessage(f,D),D.length=0}if(R&&(await U(),g))break}await U(),self.postMessage({action:"end-convert"});for(let f=0;X!==Z&&!(f>50);f++)await oe(100);self.close()}function ue(e,t){ne();for(let s=0;s<e;s++){const n=J(t>s);n.onmessage=we;const{port1:o,port2:c}=new MessageChannel;G.postMessage({action:"set-port-canvas"},[o]),n.postMessage({},[c])}}const we=e=>{const t=e.target,{data:s}=e,{action:n}=s;switch(n){case"file-load":s.workerId=t.id;case"file-converted":case"file-completed":case"file-canceled":{self.postMessage(s);break}case"file-error":{const{index:o,path:c,fileId:d}=s;j(o,c,d);break}case"list-end":{b(t),W-=P.get(t.id)||0,P.delete(t.id);break}}$(n)};function I(e,t,s,n){const o={action:e,index:t,path:s,fileId:n};self.postMessage(o),$(e)}function $(e){switch(e){case"file-completed":case"file-canceled":case"file-error":Z++;break}}function j(e,t,s){const n=r[e];if(!n)throw new Error(`the file doesn't exist. "${e}":"${t}"`);const o=V.get(n._id)||0;o<ae?(V.set(n._id,o+1),r.push(n),E.set(s,Date.now()),I("file-retry",e,t,s)):I("file-error",e,t,s)}})();
