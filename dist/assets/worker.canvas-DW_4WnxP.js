(function(){"use strict";const d=new OffscreenCanvas(100,100),P=d.getContext("bitmaprenderer");let h;const b=new Map;self.onmessage=async n=>{const{ports:e}=n;if(e[0]){h=e[0],h.onmessage=S,self.postMessage({action:"respond-to-first-message"});return}const o=n.data;for(const f of o)await R(f);self.postMessage({action:"list-end"}),d.width=1,d.height=1};async function R(n){const{index:e,file:o,bitmap:f,fileId:i,type:m,quality:g,demandThumbnail:u,isSingleImage:M,webkitRelativePath:z,maxSize:v}=n,{retriedTime:C}=n,c=z||o.webkitRelativePath||o.name,y=o.size;let a,r,t,s,x=!1;try{if(r=f,{width:t,height:s}=r,v){const l=t/s;let{width:B,height:k}=v,p=null;t>B&&(t=B,s=t/l,p={resizeWidth:t}),s>k&&(s=k,t=s*l,p={resizeHeight:s}),x=!!p,r=await createImageBitmap(r,{resizeQuality:"high",...p||{}}),f.close()}}catch{a={action:"file-error",path:c,fileId:i,index:e},self.postMessage(a);return}let I;if(u){const l=t>s?{resizeWidth:110}:{resizeHeight:80};I=await createImageBitmap(r,{...l,resizeQuality:"pixelated"})}P.transferFromImageBitmap(r),a={action:"file-load",fileId:i,path:c,index:e,thumbnail:I,width:t,height:s,shrinked:x},self.postMessage(a);let w;try{w=await d.convertToBlob({type:m,quality:g})}catch{a={action:"file-error",path:c,fileId:i,index:e},self.postMessage(a);return}const T=w.size,W={blob:w,path:c,fileId:i};h.postMessage(W),a={action:"file-converted",path:c,fileId:i,index:e,outputsize:T,inputsize:y,width:t,height:s},self.postMessage(a),b.set(i,{outputsize:T,inputsize:y,path:c,index:e})}const S=n=>{const{fileId:e,renamed:o,outputPath:f,canceled:i}=n.data,{inputsize:m,outputsize:g,path:u,index:M}=b.get(e),z={action:i?"file-canceled":"file-completed",fileId:e,path:u,index:M,inputsize:m,outputsize:g};self.postMessage(z)}})();
