(function(){"use strict";function f(){this.clear()}f.prototype.clear=function(){this._d={},this._lfh=[],this._curLFHind=0,this._cdh=[],this._cdhLen=0,this._c=0},f.prototype.add=function(r,e){if(!r)throw new Error("path is empty");if(r=String(r).replace(/\\/g,"/"),/\/{2,}|\\|^\/|^[a-z]+:/i.test(r))throw new Error('invalid path. containing a drive letter, a leading slash, or empty directory name: "'+r+'"');var n=0,t=0;if(typeof e<"u"){if(!/[^/]+$/.test(r))throw new Error('needs a file name: "'+r+'"');if(typeof e=="string"&&(e=m(e)),!(e instanceof v))try{if(e.buffer||e instanceof Array||e instanceof ArrayBuffer||e instanceof Buffer)e=new Uint8Array(e.buffer||e);else throw new Error}catch{throw new Error("data must be one of the following types Array, TypedArray, ArrayBuffer, Buffer, or string.")}if(this.has(r))throw new Error("the path already exists: "+r);n=e.length,t=M(e)}for(var o=new Date,a=h(o.getFullYear()-1980<<25|o.getMonth()+1<<21|o.getDate()<<16|o.getHours()<<11|o.getMinutes()<<5|o.getSeconds()/2),s=r.replace(/\/+$/,"").split("/"),i="";s.length;){i+=s.shift();var c=e&&s.length===0;if(i+=c?"":"/",!this._d[i]){this._d[i]=!0,this._c++;var l=m(i),g=l.length,U=c?n:0,L=h(U);this._lfh.push([80,75,3,4]);var B=[10,0,0,8,0,0].concat(a,h(c?t:0),L,L,[g&255,g>>8&255,0,0]);this._lfh.push(B,l),this._cdh.push([80,75,1,2,10,0].concat(B,[0,0,0,0,0,0,c?0:16,0,0,0],h(this._curLFHind)),l),this._cdhLen+=46+g,this._curLFHind+=30+g+U}}e&&this._lfh.push(e)},f.prototype.has=function(r){return!!this._d[r.replace(/\/+$/,"")]},f.prototype.zip=function(){var r=[80,75,5,6,0,0,0,0,this._c&255,this._c>>8,this._c&255,this._c>>8].concat(h(this._cdhLen),h(this._curLFHind),[0,0]),e,n=this._lfh.concat(this._cdh,[r]);if(v===Array)e=Array.prototype.concat.apply([],n);else{var t=0;e=new v(this._curLFHind+this._cdhLen+r.length);for(var o=0;o<n.length;o++){var a=n[o];e.set(a,t),t+=a.length}}return e},f.prototype.buffer=function(){return b?this.zip().buffer:null},f.prototype.blob=function(){return typeof Blob!="function"?null:new Blob([this.zip()],{type:"application/zip"})},f.prototype.url=function(){var r=this.blob();if(!r||typeof URL!="function"||typeof URL.createObjectURL!="function")return"";var e=URL.createObjectURL(this.blob());return e};for(var b=typeof Uint8Array<"u",v=b?Uint8Array:Array,C=b?Uint32Array:Array,_=new C(256),d=0;d<256;d++){for(var y=d,A=0;A<8;A++)y=y&1?3988292384^y>>>1:y>>>1;_[d]=y}function M(r){for(var e=4294967295,n=0,t=r.length;n<t;n++)e=_[(e^r[n])&255]^e>>>8;return(e^4294967295)>>>0}function m(r){var e;return typeof TextEncoder=="function"?e=new TextEncoder("utf-8").encode(r):(e=[],encodeURI(r).replace(/%(..)|(.)/g,function(n,t,o){e.push(t?parseInt(t,16):o.charCodeAt(0))})),e}function h(r){return[r&255,r>>8&255,r>>16&255,r>>24&255]}console.log("converter.worker.zip started");let p=new f,u=0,x=0,k=!1,F=1024*1024*1024,E=!1,z="";self.onmessage=r=>{const{data:{action:e,zipSize:n,keepExt:t,outputExt:o,buffer:a,path:s},ports:i}=r;switch(console.log("zipworker: "+e),e){case"set-port":{const c=i[0];c.onmessage=l=>R(l,c);return}case"set-config":F=n,E=!!t,z=o||"";break;case"squeeze":k=!0,setTimeout(()=>w("squeeze-zip"),10);break;case"clear":p.clear(),x=0,u=0;break;case"add-filelist":u>=F&&w("push-filelist-zip"),p.add(s,a),u+=a.byteLength,x++;break;case"squeeze-filelist":w("squeeze-filelist-zip");break;default:console.error(`zip.worker got an unknown action. "${e}"`);break}};const R=(r,e)=>{let{data:{data:n,path:t,fileId:o}}=r;if(k){e.postMessage({fileId:o,canceled:!0});return}t=t.replace(/^\//,""),E||(t=t.replace(/\.(jpe?g|jfif|pjpeg|pjp|gif|png|avif|webp|bmp|apng|ico)$/i,""));const a=2147483647;let s=t+"."+z,i=1;for(;i<=a&&p.has(s);i++){if(i===a)throw new Error(`failed to create valid output path. ${s}`);s=t+"_"+i+"."+z}const c=n,l=c.byteLength??0;u+l>F&&w("push-zip"),p.add(s,c),u+=l,x++;let g={action:"add-zip-completed",fileId:o};self.postMessage(g),e.postMessage({fileId:o,renamed:i>=2,outputPath:s})};function w(r){console.log("zipworker emitZIP: "+F,r);let e;try{e={url:p.url(),action:r,size:u,count:x}}catch(n){console.warn(n.message,r),e={action:r==="squeeze-zip"?"zip-squeeze-error":"zip-error",size:u,count:x}}self.postMessage(e),p.clear(),p=new f,x=0,u=0}})();
