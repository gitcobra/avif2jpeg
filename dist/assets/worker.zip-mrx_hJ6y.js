(function(){"use strict";function f(){this.clear()}f.prototype.clear=function(){this._d={},this._lfh=[],this._curLFHind=0,this._cdh=[],this._cdhLen=0,this._c=0},f.prototype.add=function(t,e){if(!t)throw new Error("path is empty");if(t=String(t).replace(/\\/g,"/"),/\/{2,}|\\|^\/|^[a-z]+:/i.test(t))throw new Error('invalid path. containing a drive letter, a leading slash, or empty directory name: "'+t+'"');var i=0,r=0;if(typeof e<"u"){if(!/[^/]+$/.test(t))throw new Error('needs a file name: "'+t+'"');if(typeof e=="string"&&(e=m(e)),!(e instanceof v))try{if(e.buffer||e instanceof Array||e instanceof ArrayBuffer||e instanceof Buffer)e=new Uint8Array(e.buffer||e);else throw new Error}catch{throw new Error("data must be one of the following types Array, TypedArray, ArrayBuffer, Buffer, or string.")}if(this.has(t))throw new Error("the path already exists: "+t);i=e.length,r=M(e)}for(var n=new Date,a=h(n.getFullYear()-1980<<25|n.getMonth()+1<<21|n.getDate()<<16|n.getHours()<<11|n.getMinutes()<<5|n.getSeconds()/2),o=t.replace(/\/+$/,"").split("/"),s="";o.length;){s+=o.shift();var c=e&&o.length===0;if(s+=c?"":"/",!this._d[s]){this._d[s]=!0,this._c++;var p=m(s),y=p.length,L=c?i:0,k=h(L);this._lfh.push([80,75,3,4]);var B=[10,0,0,8,0,0].concat(a,h(c?r:0),k,k,[y&255,y>>8&255,0,0]);this._lfh.push(B,p),this._cdh.push([80,75,1,2,10,0].concat(B,[0,0,0,0,0,0,c?0:16,0,0,0],h(this._curLFHind)),p),this._cdhLen+=46+y,this._curLFHind+=30+y+L}}e&&this._lfh.push(e)},f.prototype.has=function(t){return!!this._d[t.replace(/\/+$/,"")]},f.prototype.zip=function(){var t=[80,75,5,6,0,0,0,0,this._c&255,this._c>>8,this._c&255,this._c>>8].concat(h(this._cdhLen),h(this._curLFHind),[0,0]),e,i=this._lfh.concat(this._cdh,[t]);if(v===Array)e=Array.prototype.concat.apply([],i);else{var r=0;e=new v(this._curLFHind+this._cdhLen+t.length);for(var n=0;n<i.length;n++){var a=i[n];e.set(a,r),r+=a.length}}return e},f.prototype.buffer=function(){return b?this.zip().buffer:null},f.prototype.blob=function(){return typeof Blob!="function"?null:new Blob([this.zip()],{type:"application/zip"})},f.prototype.url=function(){var t=this.blob();if(!t||typeof URL!="function"||typeof URL.createObjectURL!="function")return"";var e=URL.createObjectURL(this.blob());return e};for(var b=typeof Uint8Array<"u",v=b?Uint8Array:Array,C=b?Uint32Array:Array,z=new C(256),d=0;d<256;d++){for(var g=d,A=0;A<8;A++)g=g&1?3988292384^g>>>1:g>>>1;z[d]=g}function M(t){for(var e=4294967295,i=0,r=t.length;i<r;i++)e=z[(e^t[i])&255]^e>>>8;return(e^4294967295)>>>0}function m(t){var e;return typeof TextEncoder=="function"?e=new TextEncoder("utf-8").encode(t):(e=[],encodeURI(t).replace(/%(..)|(.)/g,function(i,r,n){e.push(r?parseInt(r,16):n.charCodeAt(0))})),e}function h(t){return[t&255,t>>8&255,t>>16&255,t>>24&255]}let l=new f,u=0,x=0,E=!1,_=1024*1024*1024,U=!1,w="";self.onmessage=t=>{const{data:{action:e,zipSize:i,keepExt:r,outputExt:n,buffer:a,path:o},ports:s}=t;switch(e){case"set-port":{const c=s[0];c.onmessage=p=>R(p,c);return}case"set-config":_=i,U=!!r,w=n||"";break;case"squeeze":E=!0,setTimeout(()=>F("squeeze-zip"),10);break;case"clear":l.clear(),x=0,u=0;break;case"add-filelist":u>=_&&F("push-filelist-zip"),l.add(o,a),u+=a.byteLength,x++;break;case"squeeze-filelist":F("squeeze-filelist-zip");break}};const R=(t,e)=>{let{data:{data:i,path:r,fileId:n}}=t;if(E){e.postMessage({fileId:n,canceled:!0});return}r=r.replace(/^\//,""),U||(r=r.replace(/\.(jpe?g|jfif|pjpeg|pjp|gif|png|avif|webp|bmp|apng|ico)$/i,""));const a=2147483647;let o=r+"."+w,s=1;for(;s<=a&&l.has(o);s++){if(s===a)throw new Error(`failed to create valid output path. ${o}`);o=r+"_"+s+"."+w}const c=i,p=c.byteLength??0;u+p>_&&F("push-zip"),l.add(o,c),u+=p,x++;let y={action:"add-zip-completed",fileId:n};self.postMessage(y),e.postMessage({fileId:n,renamed:s>=2,outputPath:o})};function F(t){let e;try{e={url:l.url(),action:t,size:u,count:x}}catch{e={action:t==="squeeze-zip"?"zip-squeeze-error":"zip-error",size:u,count:x}}self.postMessage(e),l.clear(),l=new f,x=0,u=0}})();
