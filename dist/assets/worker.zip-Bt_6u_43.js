var K=Object.defineProperty;var N=(b,g,y)=>g in b?K(b,g,{enumerable:!0,configurable:!0,writable:!0,value:y}):b[g]=y;var L=(b,g,y)=>N(b,typeof g!="symbol"?g+"":g,y);(function(){"use strict";function b(o,e,t,i){return new(t||(t=Promise))(function(r,a){function l(h){try{c(i.next(h))}catch(n){a(n)}}function s(h){try{c(i.throw(h))}catch(n){a(n)}}function c(h){var n;h.done?r(h.value):(n=h.value,n instanceof t?n:new t(function(u){u(n)})).then(l,s)}c((i=i.apply(o,[])).next())})}typeof SuppressedError=="function"&&SuppressedError;const g=new Blob([Uint8Array.from([80,75,3,4,10,0,0,8,0,0])]),y=new Blob([Uint8Array.from([80,75,1,2,10,0,10,0,0,8,0,0])]),$=new Blob([Uint8Array.from([0,0,0,0,0,0,0,0,0,0])]),T=new Blob([Uint8Array.from([0,0,0,0,0,0,16,0,0,0])]),U=new TextEncoder;class D{static getCRC32(e){}constructor(){this.clear()}clear(){this._dirRecords=new Map,this._dirRecList=[],this._dirRecFileList=[],this._localFileChunks=[],this._curLocalFileHeaderOffset=0,this._centralDirHeaderChunks=[],this._centralDirHeaderLen=0,this._pathCount=0,this._fileCount=0,this._dataSize=0,this._zippedBlob=null,this._resolvingCRCPromise=null}add(e,t,i,r){if(this._zippedBlob)throw new Error("the AnZip object was already zipped. create a new instance or execute clear() before adding a file.");if(!e)throw new Error("path is empty");if(e=String(e).replace(/\\/g,"/").replace(/^\//,""),/\/{2,}|\\|^\/|^[a-z]+:/i.test(e))throw new Error('invalid path. containing a drive letter, a leading slash, or empty directory name: "'+e+'"');let a,l=0,s=null;if(t!==void 0){if(!/[^/]+$/.test(e))throw new Error('needs a file name: "'+e+'"');if(this.has(e))throw new Error('the path already exists: "'+e+'"');if(r!==void 0){if(typeof r!="number")throw new Error("precalculatedCRC must be a number");a=r}if(t instanceof Blob)s=t,l=t.size,a===void 0&&(a=0);else{if(t instanceof Uint8Array||typeof Buffer=="function"&&t instanceof Buffer)s=t;else if(typeof t=="string")s=U.encode(t);else{if(!(t instanceof ArrayBuffer||t instanceof Array))throw new Error("data must be one of the following types Array, TypedArray, ArrayBuffer, Buffer, string, or Blob.");s=new Uint8Array(t)}a===void 0&&(a=H(s)),l=s.byteLength}}let c=null;i instanceof Date?c=i:i===void 0||i===-1?c=new Date:i>=0&&(c=new Date(i));const h=c?w(c.getFullYear()-1980<<25|c.getMonth()+1<<21|c.getDate()<<16|c.getHours()<<11|c.getMinutes()<<5|c.getSeconds()/2):[0,0,0,0];let n,u,p,_=e.replace(/\/+$/,"").split("/"),f="";for(;_.length;){f+=_.shift();const m=!!(t&&_.length===0);if(f+=m?"":"/",this._dirRecords.has(f))continue;const B=U.encode(f),R=B.length,q=m&&l?w(l):[0,0,0,0],I={offset:this._curLocalFileHeaderOffset,size:l,path:f,pathLength:R,isFile:m};this._dirRecords.set(f,I),this._dirRecList.push(I),m&&this._dirRecFileList.push(I),this._pathCount++,n=Uint8Array.from([].concat(h,m?w(a):[0,0,0,0],q,q,[255&R,R>>8&255,0,0])),u=[g,n,B],this._localFileChunks.push(u);const G=m?$:T,J=Uint8Array.from(w(this._curLocalFileHeaderOffset));this._centralDirHeaderChunks.push([y,n,G,J,B]),this._centralDirHeaderLen+=46+R,this._curLocalFileHeaderOffset+=30+R+(m?l:0)}s&&(r===void 0&&s instanceof Blob&&(p=this._resolveBlobCRC(s,n,e)),u.push(s),this._dataSize+=l,this._fileCount++);let v=this._pathCount;return(p||Promise.resolve()).then(()=>v)}_resolveBlobCRC(e,t,i){let r,a;const l=this._resolvingCRCPromise||Promise.resolve(),s=new Promise((h,n)=>{r=h,a=n});this._resolvingCRCPromise=s;let c=!1;return l.finally(()=>{(function(h){return M(h).then(n=>H(new Uint8Array(n)))})(e).then(h=>{new DataView(t.buffer).setUint32(4,h,!0),c=!0}).catch(h=>{throw this.remove(i),new Error(`${h.message}
could not resolve the blob CRC.`)}).finally(()=>{this._resolvingCRCPromise===s&&(this._resolvingCRCPromise=null),c?r():a()})}),s}_checkPending(){if(this._resolvingCRCPromise)throw new Error("the AnZip object is still pending. execute wait() and await the fulfillment of the Promise beforehand.")}_getFileRecord(e){let t;return typeof e=="string"?t=this._dirRecords.get(e):typeof e=="number"&&(t=this._dirRecFileList[e]),t||null}has(e){return!!this._dirRecords.has(e.replace(/\/+$/,""))}size(){return this._dataSize}count(e){return e?this._pathCount:this._fileCount}get(e,t){const i=this._getFileRecord(e);if(i&&i.isFile){if(this._zippedBlob){const{offset:r,size:a,pathLength:l}=i,s=r+l+30;return this._zippedBlob.slice(s,s+a,t)}{const r=this._dirRecList.indexOf(i),a=this._localFileChunks[r][3];return typeof t!="string"||a instanceof Blob&&(!t||a.type===t)?a:new Blob([a],{type:t})}}return null}getPathByIndex(e){var t;return((t=this._dirRecFileList[e])===null||t===void 0?void 0:t.path)||""}remove(e){if(this._zippedBlob)throw new Error(`could not remove the file. the AnZip object is already zipped. ${e}`);const t=this._getFileRecord(e);if(!t||!t.isFile)return!1;const i=this._dirRecList.indexOf(t);this._localFileChunks.splice(i,1)[0],this._centralDirHeaderChunks.splice(i,1)[0];const r=30+t.pathLength+t.size;this._curLocalFileHeaderOffset-=r;const a=46+t.pathLength;this._centralDirHeaderLen-=a;for(let l=i;l<this._centralDirHeaderChunks.length;l++){const s=this._centralDirHeaderChunks[l][3],c=new DataView(s.buffer).getUint32(0,!0);this._centralDirHeaderChunks[l][3]=Uint8Array.from(w(c-r))}return this._pathCount--,this._fileCount--,this._dataSize-=t.size,this._dirRecords.delete(t.path),this._dirRecFileList.splice(this._dirRecFileList.indexOf(t),1),this._dirRecList.splice(this._dirRecList.indexOf(t),1),!0}list(e){const t=[];for(const[i,r]of this._dirRecords)(e||r.isFile)&&t.push({path:r.path,size:r.size,isFile:r.isFile});return t}buffer(){return this.zip().then(e=>M(e))}blob(){return this.zip()}url(){return this.zip().then(e=>URL.createObjectURL(e))}urlSync(){return URL.createObjectURL(this.zipSync())}wait(e){return b(this,void 0,void 0,function*(){for(;this._resolvingCRCPromise&&(yield this._resolvingCRCPromise,e););})}_buildZipBlob(e){return new Blob(e||this._createCurrentBlobParts(),{type:"application/zip"})}_createCurrentBlobParts(){const e=new Uint8Array([].concat([80,75,5,6,0,0,0,0,255&this._pathCount,this._pathCount>>8,255&this._pathCount,this._pathCount>>8],w(this._centralDirHeaderLen),w(this._curLocalFileHeaderOffset),[0,0]));let t=[];return t=t.concat(...this._localFileChunks,...this._centralDirHeaderChunks,e),t}zip(e){return b(this,void 0,void 0,function*(){if(this._zippedBlob)return this._zippedBlob;const t=this._createCurrentBlobParts();yield this._resolvingCRCPromise;const i=this._buildZipBlob(t);return e&&this._close(i),i})}zipSync(e){if(this._zippedBlob)return this._zippedBlob;this._checkPending();const t=this._buildZipBlob(this._createCurrentBlobParts());return e&&this._close(t),t}_close(e){this._zippedBlob=e,this._localFileChunks=[],this._centralDirHeaderChunks=[]}}const E=new Uint32Array(256);for(let o=0;o<256;o++){let e=o;for(let t=0;t<8;t++)e=1&e?3988292384^e>>>1:e>>>1;E[o]=e}function H(o){let e=4294967295;for(let t=0,i=o.length;t<i;t++)e=E[255&(e^o[t])]^e>>>8;return(4294967295^e)>>>0}function M(o){var e;return((e=o.arrayBuffer)===null||e===void 0?void 0:e.call(o))||new Promise(t=>{let i=new FileReader;i.onload=r=>{t(r.target.result)},i.onerror=()=>{throw new Error("could not read it as ArrayBuffer")},i.readAsArrayBuffer(o),i=null})}function w(o){return[255&o,o>>8&255,o>>16&255,o>>24&255]}class V{constructor(){L(this,"_currentFileCount",0);L(this,"_currentZipIndex",0);L(this,"_totalFileCount",0);L(this,"_zipLengthSumList",[]);L(this,"_pathBank",{})}increase(e){return e&&(this._pathBank[e]=[this._zipLengthSumList.length,this._currentFileCount]),this._currentFileCount++,this._totalFileCount++}split(){this._zipLengthSumList.push(this._totalFileCount),this._currentZipIndex++,this._currentFileCount=0}get(e){if(typeof e=="number"){let t=this._zipLengthSumList.findIndex((a,l)=>e<a);t===-1&&(t=this._zipLengthSumList.length);const i=this._zipLengthSumList[t-1]||0,r=e-i;return[t,r]}else{const t=this._pathBank[String(e)];if(t)return t}return null}getZipIndex(){return this._currentZipIndex}getIndex(){return this._totalFileCount}}function W(o){return new Promise(e=>setTimeout(e,o))}const F=[];let X=0;const P=new Map,x=new V;let d=new D;F.push(d);let z=0,C=0,Z=!1,A=1024*1024*1024,O=!1,S="",j="";self.onmessage=async o=>{const{data:{action:e,zipSize:t,keepExt:i,outputExt:r,file:a,index:l,path:s,imageType:c},ports:h}=o;switch(e){case"set-config":A=t,O=!!i,S=r||"",j=c||"",self.postMessage({action:"respond-set-config"});break;case"set-port-loader":{const n=h[0];self.postMessage({action:"respond-to-first-message"}),n.onmessage=u=>{const{data:{action:p},ports:_}=u;if(p==="set-port-canvas"){const f=_[0];f.onmessage=v=>Y(v,f)}};return}case"squeeze":Z=!0,await d.wait(),k("squeeze-zip");break;case"clear":d.clear(),C=0,z=0;break;case"add-filelist":{z>=A&&k("push-filelist-zip");let n=!1;if(await d.add(s,a).catch(p=>{n=!0}),n){const p={action:"error-push-filelist-zip",path:s};self.postMessage(p);break}z+=a.size,C++;let u={action:"push-filelist",size:z,count:C};self.postMessage(u);break}case"squeeze-filelist":await d.wait(),k("squeeze-filelist-zip");break;case"request-image":{const[n,u]=x.get(l),p=F[n],_=u,f=p.get(_,j);if(!f)break;const v=p.getPathByIndex(_);let B={action:"respond-image",url:URL.createObjectURL(f),index:l,path:v,fileId:P.get(l),size:f.size};self.postMessage(B);break}case"delete-image":{let n=!1;try{const[p,_]=x.get(l);F[p].remove(_),n=!0}catch{}const u={action:"respond-delete",index:l,success:n,fileId:P.get(l)};self.postMessage(u);break}}};const Y=(o,e)=>{let{data:{blob:t,path:i,fileId:r,crc:a}}=o;if(Z){e.postMessage({fileId:r,canceled:!0});return}i=i.replace(/^\//,""),O||(i=i.replace(/\.(jpe?g|jfif|pjpeg|pjp|gif|png|avif|webp|bmp|apng|ico)$/i,""));const l=2147483647;let s=i+"."+S,c=1;for(;c<=l&&d.has(s);c++){if(c===l)throw new Error(`failed to create valid output path. ${s}`);s=i+"_"+c+"."+S}const h=t.size;z+h>A&&k("push-zip"),z+=h,C++;const n=X++;P.set(n,r),x.increase(),d.add(s,t,void 0);let u={action:"add-zip-completed",fileId:r,entireIndex:n,storedPath:s};self.postMessage(u),e.postMessage({canceled:!1,fileId:r,renamed:c>=2,outputPath:s,storedPath:s,entireIndex:n})};function k(o){let e;try{const t=d,i=C,r=z;t.zip(!0).then(()=>t.url()).then(async a=>{await W(0),e={url:a,action:o,size:r,count:i},self.postMessage(e)})}catch{e={action:o==="squeeze-zip"?"zip-squeeze-error":"zip-error",size:z,count:C},self.postMessage(e)}d=new D,F.push(d),x.split(),C=0,z=0}})();
