var he=Object.defineProperty;var pe=(w,i,k)=>i in w?he(w,i,{enumerable:!0,configurable:!0,writable:!0,value:k}):w[i]=k;var W=(w,i,k)=>pe(w,typeof i!="symbol"?i+"":i,k);(function(){"use strict";function w(e){return new Worker("/avif2jpeg/dist/assets/worker.canvas-DjbX9azw.js",{name:e==null?void 0:e.name})}let i=0;class k extends w{constructor(s){super();W(this,"id",i++);W(this,"priority");this.priority=s||!1}release(){y(this)}}class J extends Promise{constructor(){super(...arguments);W(this,"wid",-1)}}const _=new Set,g=new Set,m=new Set,M=new Map,H=[];function ee(e){const t=new k;return _.add(t),O(t,e),y(t),e&&H.push(t.id),t}function O(e,t){const s=t?m:g,o=new J(n=>{M.set(e,()=>n([e,o,!!t]))});o.wid=e.id,s.add(o)}async function te(e){let t;if(!e)t=new Set([...m,...g]);else if(typeof e=="number"){const l=H.slice(0,e);t=new Set([...m].filter(d=>l.includes(d.wid)))}else t=e?m:g;const[s,o,n]=await Promise.any(t);return(n?m:g).delete(o),O(s,n),s}function y(e){const t=M.get(e);if(!t){console.warn("the worker was already released.",e.id);return}M.delete(e),t(),h==null||h(),h=null}function se(){for(const e of M.keys())y(e)}async function X(){return await Promise.all([...g,...m])}let j,h=null;async function oe(){h||(j=new Promise(e=>h=e)),await j}function ne(){se();for(const e of _)e.onmessage=null,e.terminate();_.clear(),g.clear(),m.clear(),M.clear(),i=0}function re(e){return new Promise(t=>setTimeout(t,e))}const B=1,G=2e3*2e3*5,ae=5,ie=1,le=G*6,ce=100;let U,a;const S=new Map,V=new Map,P=new Map;let p=0,C=!1,E=0,L=0;self.onmessage=async e=>{const{data:t,ports:s}=e,{action:o}=t;switch(o){case"set-zip-port":{U=s[0],self.postMessage({action:"respond-to-first-message"});break}case"start-convert":{const{list:n,fileIdList:l,outputType:d,outputQuality:z,threads:Z,maxSize:A}=t;n.forEach((T,D)=>T._id=l[D]),de(n,d,z,Z,A);break}case"cancel-convert":C=!0;break}};async function de(e,t,s,o,n){a=e;const l=Math.max(1,Math.min(o-3,a.length)),d=Math.min(ae,l);fe(l,d);const z=async()=>{for(let c=1;!C&&p>le;c++){if(console.log("overloaded ","index:",r," totalChunkSize:",p," counter:",c),c>9999)throw new Error(`maybe totalChunkSize is deadlocked :${p}`);await oe()}},A=a.length===1;let T=0,D="",r=0;for(;r<a.length;r++){const c=[];let R=!1;const we=a.length-r;Math.min(r+Math.max(Math.min(ie,we/o|0),1),a.length);let N=0,x=!1;const f=a[r],u=f._id,I=f.webkitRelativePath||f.name,me=P.get(u);if(x=x||!!me,R=r===a.length-1,E++,b("file-start",r,I,u),C){b("file-canceled",r,I,u);continue}let v;try{v=await createImageBitmap(f)}catch{console.error("error occurred while creating a bitmap",u,I),Y(r,I,u);continue}if(await z(),C){b("file-canceled",r,I,u);continue}c.push(v);const K=v.width*v.height*4;N+=K+f.size,p+=K+f.size;let F=!1;const Q=Date.now();Q-T>ce&&(T=Q,F=!0);const ke={index:r,bitmap:v,file:f,fileId:u,outputPath:D,type:t,quality:s/100,demandThumbnail:F||R,isSingleImage:A,maxSize:n,retriedTime:P.get(u)||0,webkitRelativePath:f.webkitRelativePath};F=!1;let $;const ge=N>G;$=await te(d>0&&(x?1:ge)),S.set($.id,N),$.postMessage(ke,c),c.length=0,R&&await X()}console.log("end file loop",a.length),console.log("end of totalChunkSize: ",p),await X(),console.log("resolved all workers"),self.postMessage({action:"end-convert"});for(let c=0;E!==L;c++){if(c>50){console.error(`resolvedCount is unequal to startedCount. resolvedCount:${L} startedCount:${E}`);break}await re(100)}self.postMessage({action:"close-loader"}),console.log("successfully close worker.loader."),self.close()}function fe(e,t){ne();for(let s=0;s<e;s++){const o=ee(t>s);o.onmessage=ue;const{port1:n,port2:l}=new MessageChannel;U.postMessage({action:"set-port-canvas"},[n]),o.postMessage({},[l])}}const ue=e=>{const t=e.target,{data:s}=e,{action:o}=s;switch(o){case"file-load":s.workerId=t.id;case"file-converted":case"file-canceled":{self.postMessage(s);break}case"file-completed":{y(t),p-=S.get(t.id)||0,S.delete(t.id),self.postMessage(s);break}case"file-error":{const{index:n,path:l,fileId:d}=s;Y(n,l,d);break}case"list-start":case"list-end":case"respond-to-first-message":break;default:console.error(`unexptected action "${o}"`)}q(o)};function b(e,t,s,o){const n={action:e,index:t,path:s,fileId:o};self.postMessage(n),q(e)}function q(e){switch(e){case"file-completed":case"file-canceled":case"file-error":case"file-retry":L++;break}}function Y(e,t,s){const o=a[e];if(!o)throw new Error(`the file doesn't exist. "${e}":"${t}"`);const n=V.get(o._id)||0;n<B?(V.set(o._id,n+1),a.push(o),P.set(s,Date.now()),b("file-retry",e,t,s)):(console.error(`failed to load "${t}" after ${B} retries. the image may be corrupted or cannot be read by some reason.`),b("file-error",e,t,s))}})();
