(function(){"use strict";const w=new OffscreenCanvas(100,100),P=w.getContext("bitmaprenderer");let d;const M=new Map;self.onmessage=async l=>{const{ports:e}=l;if(e[0]){d=e[0],d.onmessage=R;return}const n=l.data;for(const t of n)await T(t);self.postMessage({action:"list-end"})};async function T(l){const{index:e,file:n,fileId:t,type:m,quality:g,demandThumbnail:h,isSingleImage:b,webkitRelativePath:u,maxSize:f}=l,o=u||n.webkitRelativePath||n.name,v=n.size;let a;a={action:"file-start",path:o,fileId:t,index:e},self.postMessage(a);let c,s,i,y=!1;try{if(c=await createImageBitmap(n),{width:s,height:i}=c,f){const r=s/i;let{width:x,height:k}=f,p=null;s>x&&(s=x,i=s/r,p={resizeWidth:s}),i>k&&(i=k,s=i*r,p={resizeHeight:i}),y=!!p,c=await createImageBitmap(c,{resizeQuality:"high",...p||{}})}}catch{a={action:"file-error",path:o,fileId:t,index:e},self.postMessage(a);return}let I=null;if(h){const r=s>i?{resizeWidth:110}:{resizeHeight:80};I=await createImageBitmap(c,{...r,resizeQuality:"low"})}P.transferFromImageBitmap(c),a={action:"file-load",fileId:t,path:o,index:e,thumbnail:I,width:s,height:i,shrinked:y},self.postMessage(a);let z;try{z=await w.convertToBlob({type:m,quality:g})}catch{a={action:"file-error",path:o,fileId:t,index:e},self.postMessage(a);return}const B=z.size;d.postMessage({blob:z,path:o,fileId:t}),a={action:"file-converted",path:o,fileId:t,index:e,outputsize:B,inputsize:v,width:s,height:i},self.postMessage(a),M.set(t,{outputsize:B,inputsize:v,path:o,index:e})}const R=l=>{const{fileId:e,renamed:n,outputPath:t,canceled:m}=l.data,{inputsize:g,outputsize:h,path:b,index:u}=M.get(e),f={action:m?"file-canceled":"file-completed",fileId:e,path:b,index:u,inputsize:g,outputsize:h};self.postMessage(f)}})();
