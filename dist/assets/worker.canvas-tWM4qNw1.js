(function(){"use strict";const f=new OffscreenCanvas(100,100),R=f.getContext("bitmaprenderer");let m;const M=new Map;self.onmessage=async n=>{const{ports:e}=n;if(e[0]){m=e[0],m.onmessage=W,self.postMessage({action:"respond-to-first-message"});return}const o=n.data;for(const d of o)await S(d);self.postMessage({action:"list-end"}),f.width=1,f.height=1};async function S(n){const{index:e,file:o,bitmap:d,fileId:i,type:g,quality:u,demandThumbnail:z,isSingleImage:v,webkitRelativePath:w,maxSize:p}=n,{retriedTime:y}=n,r=w||o.webkitRelativePath||o.name,x=o.size;let a,c,t,s,I=!1;try{if(c=d,{width:t,height:s}=c,p){const l=t/s;let{width:P,height:k}=p,h=null;t>P&&(t=P,s=t/l,h={resizeWidth:t}),s>k&&(s=k,t=s*l,h={resizeHeight:s}),I=!!h,c=await createImageBitmap(c,{resizeQuality:"high",...h||{}}),d.close()}}catch{a={action:"file-error",path:r,fileId:i,index:e},self.postMessage(a);return}let T;if(z){const l=t>s?{resizeWidth:110}:{resizeHeight:80};T=await createImageBitmap(c,{...l,resizeQuality:"pixelated"})}R.transferFromImageBitmap(c),a={action:"file-load",fileId:i,path:r,index:e,thumbnail:T,width:t,height:s,shrinked:I},self.postMessage(a);let b;try{b=await f.convertToBlob({type:g,quality:u})}catch{a={action:"file-error",path:r,fileId:i,index:e},self.postMessage(a);return}const B=b.size,C={blob:b,path:r,fileId:i};m.postMessage(C),a={action:"file-converted",path:r,fileId:i,index:e,outputsize:B,inputsize:x,width:t,height:s},self.postMessage(a),M.set(i,{outputsize:B,inputsize:x,path:r,index:e})}const W=n=>{const{fileId:e,renamed:o,outputPath:d,canceled:i,entireIndex:g,storedPath:u}=n.data,{inputsize:z,outputsize:v,path:w,index:p}=M.get(e),y={action:i?"file-canceled":"file-completed",fileId:e,path:w,index:p,inputsize:z,outputsize:v,entireIndex:g,storedPath:u};self.postMessage(y)}})();
