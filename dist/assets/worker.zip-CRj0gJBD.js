var J=Object.defineProperty;var K=(b,g,y)=>g in b?J(b,g,{enumerable:!0,configurable:!0,writable:!0,value:y}):b[g]=y;var L=(b,g,y)=>K(b,typeof g!="symbol"?g+"":g,y);(function(){"use strict";function b(a,t,e,i){return new(e||(e=Promise))(function(r,o){function n(h){try{c(i.next(h))}catch(l){o(l)}}function s(h){try{c(i.throw(h))}catch(l){o(l)}}function c(h){var l;h.done?r(h.value):(l=h.value,l instanceof e?l:new e(function(u){u(l)})).then(n,s)}c((i=i.apply(a,[])).next())})}typeof SuppressedError=="function"&&SuppressedError;const g=new Blob([Uint8Array.from([80,75,3,4,10,0,0,8,0,0])]),y=new Blob([Uint8Array.from([80,75,1,2,10,0,10,0,0,8,0,0])]),T=new Blob([Uint8Array.from([0,0,0,0,0,0,0,0,0,0])]),V=new Blob([Uint8Array.from([0,0,0,0,0,0,16,0,0,0])]),D=new TextEncoder;class E{static getCRC32(t){}constructor(){this.clear()}clear(){this._dirRecords=new Map,this._dirRecList=[],this._dirRecFileList=[],this._localFileChunks=[],this._curLocalFileHeaderOffset=0,this._centralDirHeaderChunks=[],this._centralDirHeaderLen=0,this._pathCount=0,this._fileCount=0,this._dataSize=0,this._zippedBlob=null,this._resolvingCRCPromise=null}add(t,e,i,r){if(this._zippedBlob)throw new Error("the AnZip object was already zipped. create a new instance or execute clear() before adding a file.");if(!t)throw new Error("path is empty");if(t=String(t).replace(/\\/g,"/").replace(/^\//,""),/\/{2,}|\\|^\/|^[a-z]+:/i.test(t))throw new Error('invalid path. containing a drive letter, a leading slash, or empty directory name: "'+t+'"');let o,n=0,s=null;if(e!==void 0){if(!/[^/]+$/.test(t))throw new Error('needs a file name: "'+t+'"');if(this.has(t))throw new Error('the path already exists: "'+t+'"');if(r!==void 0){if(typeof r!="number")throw new Error("precalculatedCRC must be a number");o=r}if(e instanceof Blob)s=e,n=e.size,o===void 0&&(o=0);else{if(e instanceof Uint8Array||typeof Buffer=="function"&&e instanceof Buffer)s=e;else if(typeof e=="string")s=D.encode(e);else{if(!(e instanceof ArrayBuffer||e instanceof Array))throw new Error("data must be one of the following types Array, TypedArray, ArrayBuffer, Buffer, string, or Blob.");s=new Uint8Array(e)}o===void 0&&(o=M(s)),n=s.byteLength}}let c=null;i instanceof Date?c=i:i===void 0||i===-1?c=new Date:i>=0&&(c=new Date(i));const h=c?C(c.getFullYear()-1980<<25|c.getMonth()+1<<21|c.getDate()<<16|c.getHours()<<11|c.getMinutes()<<5|c.getSeconds()/2):[0,0,0,0];let l,u,p,_=t.replace(/\/+$/,"").split("/"),f="";for(;_.length;){f+=_.shift();const m=!!(e&&_.length===0);if(f+=m?"":"/",this._dirRecords.has(f))continue;const B=D.encode(f),R=B.length,$=m&&n?C(n):[0,0,0,0],U={offset:this._curLocalFileHeaderOffset,size:n,path:f,pathLength:R,isFile:m};this._dirRecords.set(f,U),this._dirRecList.push(U),m&&this._dirRecFileList.push(U),this._pathCount++,l=Uint8Array.from([].concat(h,m?C(o):[0,0,0,0],$,$,[255&R,R>>8&255,0,0])),u=[g,l,B],this._localFileChunks.push(u);const Y=m?T:V,G=Uint8Array.from(C(this._curLocalFileHeaderOffset));this._centralDirHeaderChunks.push([y,l,Y,G,B]),this._centralDirHeaderLen+=46+R,this._curLocalFileHeaderOffset+=30+R+(m?n:0)}s&&(r===void 0&&s instanceof Blob&&(p=this._resolveBlobCRC(s,l,t)),u.push(s),this._dataSize+=n,this._fileCount++);let v=this._pathCount;return(p||Promise.resolve()).then(()=>v)}_resolveBlobCRC(t,e,i){let r,o;const n=this._resolvingCRCPromise||Promise.resolve(),s=new Promise((h,l)=>{r=h,o=l});this._resolvingCRCPromise=s;let c=!1;return n.finally(()=>{(function(h){return Z(h).then(l=>M(new Uint8Array(l)))})(t).then(h=>{new DataView(e.buffer).setUint32(4,h,!0),c=!0}).catch(h=>{throw this.remove(i),new Error(`${h.message}
could not resolve the blob CRC.`)}).finally(()=>{this._resolvingCRCPromise===s&&(this._resolvingCRCPromise=null),c?r():o()})}),s}_checkPending(){if(this._resolvingCRCPromise)throw new Error("the AnZip object is still pending. execute wait() and await the fulfillment of the Promise beforehand.")}_getFileRecord(t){let e;return typeof t=="string"?e=this._dirRecords.get(t):typeof t=="number"&&(e=this._dirRecFileList[t]),e||null}has(t){return!!this._dirRecords.has(t.replace(/\/+$/,""))}size(){return this._dataSize}count(t){return t?this._pathCount:this._fileCount}get(t,e){const i=this._getFileRecord(t);if(i&&i.isFile){if(this._zippedBlob){const{offset:r,size:o,pathLength:n}=i,s=r+n+30;return this._zippedBlob.slice(s,s+o,e)}{const r=this._dirRecList.indexOf(i),o=this._localFileChunks[r][3];return typeof e!="string"||o instanceof Blob&&(!e||o.type===e)?o:new Blob([o],{type:e})}}return null}getPathByIndex(t){var e;return((e=this._dirRecFileList[t])===null||e===void 0?void 0:e.path)||""}remove(t){if(this._zippedBlob)throw new Error(`could not remove the file. the AnZip object is already zipped. ${t}`);const e=this._getFileRecord(t);if(!e||!e.isFile)return!1;const i=this._dirRecList.indexOf(e);this._localFileChunks.splice(i,1)[0],this._centralDirHeaderChunks.splice(i,1)[0];const r=30+e.pathLength+e.size;this._curLocalFileHeaderOffset-=r;const o=46+e.pathLength;this._centralDirHeaderLen-=o;for(let n=i;n<this._centralDirHeaderChunks.length;n++){const s=this._centralDirHeaderChunks[n][3],c=new DataView(s.buffer).getUint32(0,!0);this._centralDirHeaderChunks[n][3]=Uint8Array.from(C(c-r))}return this._pathCount--,this._fileCount--,this._dataSize-=e.size,this._dirRecords.delete(e.path),this._dirRecFileList.splice(this._dirRecFileList.indexOf(e),1),this._dirRecList.splice(this._dirRecList.indexOf(e),1),!0}list(t){const e=[];for(const[i,r]of this._dirRecords)(t||r.isFile)&&e.push({path:r.path,size:r.size,isFile:r.isFile});return e}buffer(){return this.zip().then(t=>Z(t))}blob(){return this.zip()}url(){return this.zip().then(t=>URL.createObjectURL(t))}urlSync(){return URL.createObjectURL(this.zipSync())}wait(t){return b(this,void 0,void 0,function*(){for(;this._resolvingCRCPromise&&(yield this._resolvingCRCPromise,t););})}_buildZipBlob(t){return new Blob(t||this._createCurrentBlobParts(),{type:"application/zip"})}_createCurrentBlobParts(){const t=new Uint8Array([].concat([80,75,5,6,0,0,0,0,255&this._pathCount,this._pathCount>>8,255&this._pathCount,this._pathCount>>8],C(this._centralDirHeaderLen),C(this._curLocalFileHeaderOffset),[0,0]));let e=[];return e=e.concat(...this._localFileChunks,...this._centralDirHeaderChunks,t),e}zip(t){return b(this,void 0,void 0,function*(){if(this._zippedBlob)return this._zippedBlob;const e=this._createCurrentBlobParts();yield this._resolvingCRCPromise;const i=this._buildZipBlob(e);return t&&this._close(i),i})}zipSync(t){if(this._zippedBlob)return this._zippedBlob;this._checkPending();const e=this._buildZipBlob(this._createCurrentBlobParts());return t&&this._close(e),e}_close(t){this._zippedBlob=t,this._localFileChunks=[],this._centralDirHeaderChunks=[]}}const H=new Uint32Array(256);for(let a=0;a<256;a++){let t=a;for(let e=0;e<8;e++)t=1&t?3988292384^t>>>1:t>>>1;H[a]=t}function M(a){let t=4294967295;for(let e=0,i=a.length;e<i;e++)t=H[255&(t^a[e])]^t>>>8;return(4294967295^t)>>>0}function Z(a){var t;return((t=a.arrayBuffer)===null||t===void 0?void 0:t.call(a))||new Promise(e=>{let i=new FileReader;i.onload=r=>{e(r.target.result)},i.onerror=()=>{throw new Error("could not read it as ArrayBuffer")},i.readAsArrayBuffer(a),i=null})}function C(a){return[255&a,a>>8&255,a>>16&255,a>>24&255]}class W{constructor(){L(this,"_currentFileCount",0);L(this,"_currentZipIndex",0);L(this,"_totalFileCount",0);L(this,"_zipLengthSumList",[]);L(this,"_pathBank",{})}increase(t){return t&&(this._pathBank[t]=[this._zipLengthSumList.length,this._currentFileCount]),this._currentFileCount++,this._totalFileCount++}split(){this._zipLengthSumList.push(this._totalFileCount),this._currentZipIndex++,this._currentFileCount=0}get(t){if(typeof t=="number"){let e=this._zipLengthSumList.findIndex((o,n)=>t<o);e===-1&&(e=this._zipLengthSumList.length);const i=this._zipLengthSumList[e-1]||0,r=t-i;return[e,r]}else{const e=this._pathBank[String(t)];if(e)return e}return null}getZipIndex(){return this._currentZipIndex}getIndex(){return this._totalFileCount}}const F=[];let P=0;const A=new Map,x=new W;let d=new E;F.push(d);let z=0,w=0,O=!1,S=1024*1024*1024,j=!1,I="",q="";self.onmessage=async a=>{const{data:{action:t,zipSize:e,keepExt:i,outputExt:r,file:o,index:n,path:s,imageType:c},ports:h}=a;switch(t){case"set-config":S=e,j=!!i,I=r||"",q=c||"",self.postMessage({action:"respond-set-config"});break;case"set-port-loader":{const l=h[0];self.postMessage({action:"respond-to-first-message"}),l.onmessage=u=>{const{data:{action:p},ports:_}=u;if(p==="set-port-canvas"){const f=_[0];f.onmessage=v=>X(v,f)}};return}case"squeeze":O=!0,await d.wait(),k("squeeze-zip");break;case"clear":d.clear(),w=0,z=0;break;case"add-filelist":{z>=S&&k("push-filelist-zip");let l=!1;if(await d.add(s,o).catch(p=>{l=!0}),l){const p={action:"error-push-filelist-zip",path:s};self.postMessage(p);break}z+=o.size,w++;let u={action:"push-filelist",size:z,count:w};self.postMessage(u);break}case"squeeze-filelist":await d.wait(),k("squeeze-filelist-zip");break;case"request-image":{const[l,u]=x.get(n),p=F[l],_=u,f=p.get(_,q);if(!f)break;const v=p.getPathByIndex(_);let B={action:"respond-image",url:URL.createObjectURL(f),index:n,path:v,fileId:A.get(n),size:f.size};self.postMessage(B);break}case"delete-image":{let l=!1;try{const[p,_]=x.get(n);F[p].remove(_),l=!0}catch{}const u={action:"respond-delete",index:n,success:l,fileId:A.get(n)};self.postMessage(u);break}}};const X=(a,t)=>{let{data:{blob:e,path:i,fileId:r,crc:o}}=a;if(O){t.postMessage({fileId:r,canceled:!0});return}i=i.replace(/^\//,""),j||(i=i.replace(/\.(jpe?g|jfif|pjpeg|pjp|gif|png|avif|webp|bmp|apng|ico)$/i,""));const n=2147483647;let s=i+"."+I,c=1;for(;c<=n&&d.has(s);c++){if(c===n)throw new Error(`failed to create valid output path. ${s}`);s=i+"_"+c+"."+I}const h=e.size;z+h>S&&k("push-zip"),z+=h,w++,A.set(P++,r),x.increase(),d.add(s,e,void 0);let l={action:"add-zip-completed",fileId:r,entireIndex:P-1,storedPath:s};self.postMessage(l),t.postMessage({canceled:!1,fileId:r,renamed:c>=2,outputPath:s,storedPath:s,entireIndex:P-1})};function k(a){let t;try{const e=d,i=w,r=z;e.zip(!0).then(()=>e.url()).then(o=>(t={url:o,action:a,size:r,count:i},new Promise(n=>setTimeout(n,0)))).then(()=>{self.postMessage(t)}).catch(o=>{})}catch{t={action:a==="squeeze-zip"?"zip-squeeze-error":"zip-error",size:z,count:w},self.postMessage(t)}d=new E,F.push(d),x.split(),w=0,z=0}})();
