var me=Object.defineProperty;var he=(f,c,g)=>c in f?me(f,c,{enumerable:!0,configurable:!0,writable:!0,value:g}):f[c]=g;var P=(f,c,g)=>he(f,typeof c!="symbol"?c+"":c,g);(function(){"use strict";function f(e){return new Worker("/avif2jpeg/dist/assets/worker.canvas-tWM4qNw1.js",{name:e==null?void 0:e.name})}let c=0;class g extends f{constructor(n){super();P(this,"id",c++);P(this,"priority");this.priority=n||!1}release(){S(this)}}class Z extends Promise{constructor(){super(...arguments);P(this,"wid",-1)}}const A=new Set,p=new Set,d=new Set,_=new Map,F=[];function j(e){const t=new g;return A.add(t),x(t,e),S(t),e&&F.push(t.id),t}function x(e,t){const n=t?d:p,s=new Z(o=>{_.set(e,()=>o([e,s,!!t]))});s.wid=e.id,n.add(s)}async function q(e){let t;if(!e)t=new Set([...d,...p]);else if(typeof e=="number"){const r=F.slice(0,e);t=new Set([...d].filter(l=>r.includes(l.wid)))}else t=e?d:p;const[n,s,o]=await Promise.any(t);return(o?d:p).delete(s),x(n,o),n}function S(e){const t=_.get(e);t&&(_.delete(e),t(),M==null||M(),M=null)}function K(){for(const e of _.keys())S(e)}async function H(){return await Promise.all([...p,...d])}let O,M=null;async function Y(){M||(O=new Promise(e=>M=e)),await O}function Q(){K();for(const e of A)e.onmessage=null,e.terminate();A.clear(),p.clear(),d.clear(),_.clear(),c=0}const J=1,z=2e3*2e3*5,ee=5,te=1,se=z*1,ne=z*6,oe=100;let I=!1,U;self.onmessage=async e=>{const{data:t,ports:n}=e,{action:s}=t;switch(s){case"set-zip-port":{U=n[0],self.postMessage({action:"respond-to-first-message"});break}case"start-convert":{const{list:o,fileIdList:r,outputType:l,outputQuality:w,threads:b}=t;o.forEach((C,v)=>C._id=r[v]),ae(o,l,w,b);break}case"cancel-convert":I=!0;break}};async function ae(e,t,n,s){let o=0;const r=new Map,l=new Map,w=new Map,b=Math.max(1,Math.min(s-3,e.length)),C=Math.min(ee,b),v=(a,k,m)=>{const W=e[a];if(!W)throw new Error(`the file doesn't exist. "${a}":"${k}"`);const y=l.get(W._id)||0;y<J?(l.set(W._id,y+1),e.push(W),w.set(m,Date.now()),ce(a,k,m)):le(a,k,m)},ue=ie(v,a=>{o-=r.get(a)||0,r.delete(a)}),B=async()=>{for(let a=1;!I&&o>ne;a++){if(a>9999)throw new Error(`totalChunkSize is deadlocking :${o}`);await Y()}};re(b,C,ue);const fe=e.length===1;let G=0,de="",i=0;for(o=0,r.clear();i<e.length;){const a=[],k=[];let m=!1;const W=e.length-i,y=Math.min(i+Math.max(Math.min(te,W/s|0),1),e.length);let L=0,N=!1;for(;i<y;i++){if(L>se&&!I){await B();break}const u=e[i],h=u._id,E=u.webkitRelativePath||u.name,we=w.get(h);N=N||!!we,m=i===e.length-1;const ke={action:"file-start",index:i,path:E,fileId:h};if(self.postMessage(ke),I){$(i,E,h);continue}let T;try{T=await createImageBitmap(u)}catch{v(i,E,h);continue}if(await B(),I){$(i,E,h);continue}k.push(T);const V=T.width*T.height*4;L+=V+u.size,o+=V+u.size;let D=!1;const X=Date.now();X-G>oe&&(G=X,D=!0),a.push({index:i,bitmap:T,file:u,fileId:h,outputPath:de,type:t,quality:n/100,demandThumbnail:D||m,isSingleImage:fe,maxSize:null,retriedTime:w.get(h)||0,webkitRelativePath:u.webkitRelativePath}),D=!1}let R;if(a.length){const u=L>z;R=await q(C>0&&(N?1:u)),r.set(R.id,L),R.postMessage(a,k),k.length=0}if(m&&(await H(),I))break}await H(),self.postMessage({action:"end-convert"})}function re(e,t,n){Q();for(let s=0;s<e;s++){const o=j(t>s);o.onmessage=n;const{port1:r,port2:l}=new MessageChannel;U.postMessage({action:"set-port-canvas"},[r]),o.postMessage({},[l])}}function ie(e,t){return n=>{const s=n.target,{data:o}=n,{action:r}=o;switch(r){case"list-start":break;case"file-load":o.workerId=s.id;case"file-converted":case"file-completed":case"file-canceled":self.postMessage(o);break;case"file-error":{const{index:l,path:w,fileId:b}=o;e(l,w,b);break}case"list-end":{S(s),t(s.id);break}case"respond-to-first-message":break;default:throw new Error(`unexptected action "${r}"`)}}}function $(e,t,n){const s={action:"file-canceled",index:e,path:t,fileId:n};self.postMessage(s)}function ce(e,t,n){const s={action:"file-retry",index:e,path:t,fileId:n};self.postMessage(s)}function le(e,t,n){const s={action:"file-error",index:e,path:t,fileId:n};self.postMessage(s)}})();
