var pe=Object.defineProperty;var ge=(u,i,k)=>i in u?pe(u,i,{enumerable:!0,configurable:!0,writable:!0,value:k}):u[i]=k;var _=(u,i,k)=>ge(u,typeof i!="symbol"?i+"":i,k);(function(){"use strict";function u(e){return new Worker("/avif2jpeg/dist/assets/worker.canvas-DJWk42OT.js",{name:e==null?void 0:e.name})}let i=0;class k extends u{constructor(s){super();_(this,"id",i++);_(this,"priority");this.priority=s||!1}release(){T(this)}}class K extends Promise{constructor(){super(...arguments);_(this,"wid",-1)}}const C=new Set,h=new Set,w=new Set,M=new Map,x=[];function Q(e){const t=new k;return C.add(t),O(t,e),T(t),e&&x.push(t.id),t}function O(e,t){const s=t?w:h,n=new K(o=>{M.set(e,()=>o([e,n,!!t]))});n.wid=e.id,s.add(n)}async function ee(e){let t;if(!e)t=new Set([...w,...h]);else if(typeof e=="number"){const a=x.slice(0,e);t=new Set([...w].filter(f=>a.includes(f.wid)))}else t=e?w:h;const[s,n,o]=await Promise.any(t);return(o?w:h).delete(n),O(s,o),s}function T(e){const t=M.get(e);t&&(M.delete(e),t(),p==null||p(),p=null)}function te(){for(const e of M.keys())T(e)}async function H(){return await Promise.all([...h,...w])}let j,p=null;async function se(){p||(j=new Promise(e=>p=e)),await j}function ne(){te();for(const e of C)e.onmessage=null,e.terminate();C.clear(),h.clear(),w.clear(),M.clear(),i=0}function oe(e){return new Promise(t=>setTimeout(t,e))}const ae=1,B=2e3*2e3*5,re=5,ie=1,ce=B*6,le=100;let G,c;const S=new Map,U=new Map,E=new Map;let W=0,P=!1,V=0,X=0;self.onmessage=async e=>{const{data:t,ports:s}=e,{action:n}=t;switch(n){case"set-zip-port":{G=s[0],self.postMessage({action:"respond-to-first-message"});break}case"start-convert":{const{list:o,extraPropsForList:a,outputType:f,outputQuality:L,threads:Z,maxSize:A}=t;o.forEach((g,v)=>{g._id=a[v][0],g.webkitRelativePath||Object.defineProperty(g,"webkitRelativePath",{value:a[v][1]})}),fe(o,f,L,Z,A);break}case"cancel-convert":P=!0;break}};async function fe(e,t,s,n,o){c=e;const a=Math.max(1,Math.min(n-3,c.length)),f=Math.min(re,a);de(a,f);const L=async()=>{for(let l=1;!P&&W>ce;l++){if(l>9999)throw new Error(`maybe totalChunkSize is deadlocked :${W}`);await se()}},A=c.length===1;let g=0,v="",r=0;for(;r<c.length;r++){const l=[];let R=!1;const we=c.length-r;Math.min(r+Math.max(Math.min(ie,we/n|0),1),c.length);let D=0,z=!1;const d=c[r],m=d._id,y=d.webkitRelativePath||d.name,me=E.get(m);if(z=z||!!me,R=r===c.length-1,V++,I("file-start",r,y,m),P){I("file-canceled",r,y,m);continue}let b;try{b=await createImageBitmap(d)}catch{Y(r,y,m);continue}if(await L(),P){I("file-canceled",r,y,m);continue}l.push(b);const q=b.width*b.height*4;D+=q+d.size,W+=q+d.size;let F=!1;const J=Date.now();J-g>le&&(g=J,F=!0);const ke={index:r,bitmap:b,file:d,fileId:m,outputPath:v,type:t,quality:s/100,demandThumbnail:F||R,isSingleImage:A,maxSize:o,retriedTime:E.get(m)||0,webkitRelativePath:d.webkitRelativePath};F=!1;let N;const he=D>B;N=await ee(f>0&&(z?1:he)),S.set(N.id,D),N.postMessage(ke,l),l.length=0,R&&await H()}await H(),self.postMessage({action:"end-convert"});for(let l=0;V!==X&&!(l>50);l++)await oe(100);self.postMessage({action:"close-loader"}),self.close()}function de(e,t){ne();for(let s=0;s<e;s++){const n=Q(t>s);n.onmessage=ue;const{port1:o,port2:a}=new MessageChannel;G.postMessage({action:"set-port-canvas"},[o]),n.postMessage({},[a])}}const ue=e=>{const t=e.target,{data:s}=e,{action:n}=s;switch(n){case"file-load":s.workerId=t.id;case"file-converted":case"file-canceled":{self.postMessage(s);break}case"file-completed":{T(t),W-=S.get(t.id)||0,S.delete(t.id),self.postMessage(s);break}case"file-error":{const{index:o,path:a,fileId:f}=s;Y(o,a,f);break}}$(n)};function I(e,t,s,n){const o={action:e,index:t,path:s,fileId:n};self.postMessage(o),$(e)}function $(e){switch(e){case"file-completed":case"file-canceled":case"file-error":case"file-retry":X++;break}}function Y(e,t,s){const n=c[e];if(!n)throw new Error(`the file doesn't exist. "${e}":"${t}"`);const o=U.get(n._id)||0;o<ae?(U.set(n._id,o+1),c.push(n),E.set(s,Date.now()),I("file-retry",e,t,s)):I("file-error",e,t,s)}})();
