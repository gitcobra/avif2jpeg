(function(){"use strict";const d=new OffscreenCanvas(100,100),S=d.getContext("bitmaprenderer");let g;const y=new Map;self.onmessage=async c=>{const{ports:e}=c;if(e[0]){g=e[0],g.onmessage=F,self.postMessage({action:"respond-to-first-message"});return}const r=c.data;for(const h of r)await C(h);self.postMessage({action:"list-end"}),d.width=1,d.height=1};async function C(c){const{index:e,file:r,bitmap:h,fileId:s,type:u,quality:m,demandThumbnail:w,isSingleImage:x,webkitRelativePath:z,maxSize:f}=c,a=z||r.webkitRelativePath||r.name,I=r.size;let o,B=0,P=0,n,t,i,b,M,T=!1;try{if(n=h,{width:t,height:i}=n,B=b=t,P=M=i,f){const l=t/i;let{width:H,height:R}=f,p=null;t>H&&(t=H,i=t/l,p={resizeWidth:t}),i>R&&(i=R,t=i*l,p={resizeHeight:i}),T=!!p,n=await createImageBitmap(n,{resizeQuality:"high",...p||{}}),b=n.width,M=n.height,h.close()}}catch{o={action:"file-error",path:a,fileId:s,index:e},self.postMessage(o);return}let W;if(w){const l=t>i?{resizeWidth:110}:{resizeHeight:80};W=await createImageBitmap(n,{...l,resizeQuality:"pixelated"})}S.transferFromImageBitmap(n),o={action:"file-load",fileId:s,path:a,index:e,thumbnail:W,width:B,height:P,inputsize:I},self.postMessage(o);let v;try{v=await d.convertToBlob({type:u,quality:m})}catch{o={action:"file-error",path:a,fileId:s,index:e},self.postMessage(o);return}const k=v.size,O={blob:v,path:a,fileId:s};g.postMessage(O),o={action:"file-converted",path:a,fileId:s,index:e,outputsize:k,outputWidth:b,outputHeight:M,shrinked:T},self.postMessage(o),y.set(s,{outputsize:k,inputsize:I,path:a,index:e})}const F=c=>{const{fileId:e,renamed:r,outputPath:h,canceled:s,entireIndex:u,storedPath:m}=c.data,{inputsize:w,outputsize:x,path:z,index:f}=y.get(e),a={action:s?"file-canceled":"file-completed",fileId:e,path:z,index:f,inputsize:w,outputsize:x,entireIndex:u,storedPath:m};self.postMessage(a)}})();
