(function(){"use strict";const l=new OffscreenCanvas(100,100),S=l.getContext("bitmaprenderer");let p;const y=new Map;self.onmessage=async c=>{const{ports:e}=c;if(e[0]){p=e[0],p.onmessage=F,self.postMessage({action:"respond-to-first-message"});return}await C(c.data),self.postMessage({action:"list-end"}),l.width=1,l.height=1};async function C(c){const{index:e,file:h,bitmap:f,fileId:a,type:u,quality:m,demandThumbnail:w,isSingleImage:I,webkitRelativePath:z,maxSize:d}=c,o=z||h.webkitRelativePath||h.name,x=h.size;let n,B=0,P=0,t,i,s,b,M,T=!1;try{if(t=f,{width:i,height:s}=t,B=b=i,P=M=s,d){const r=i/s;let{width:H,height:R}=d,g=null;i>H&&(i=H,s=i/r,g={resizeWidth:i}),s>R&&(s=R,i=s*r,g={resizeHeight:s}),T=!!g,t=await createImageBitmap(t,{resizeQuality:"high",...g||{}}),b=t.width,M=t.height,f.close()}}catch{n={action:"file-error",path:o,fileId:a,index:e},self.postMessage(n);return}let W;if(w){const r=i>s?{resizeWidth:110}:{resizeHeight:80};W=await createImageBitmap(t,{...r,resizeQuality:"low"})}S.transferFromImageBitmap(t),t.close(),n={action:"file-load",fileId:a,path:o,index:e,thumbnail:W,width:B,height:P,inputsize:x},self.postMessage(n);let v;try{v=await l.convertToBlob({type:u,quality:m})}catch{n={action:"file-error",path:o,fileId:a,index:e},self.postMessage(n);return}const k=v.size;l.width=1,l.height=1,n={action:"file-converted",path:o,fileId:a,index:e,outputsize:k,outputWidth:b,outputHeight:M,shrinked:T},self.postMessage(n),y.set(a,{outputsize:k,inputsize:x,path:o,index:e});const O={blob:v,path:o,fileId:a};p.postMessage(O)}const F=c=>{const{fileId:e,renamed:h,outputPath:f,canceled:a,entireIndex:u,storedPath:m}=c.data,{inputsize:w,outputsize:I,path:z,index:d}=y.get(e),o={action:a?"file-canceled":"file-completed",fileId:e,path:z,index:d,inputsize:w,outputsize:I,entireIndex:u,storedPath:m};self.postMessage(o)}})();
