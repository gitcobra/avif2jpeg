var ge=Object.defineProperty;var Me=(u,i,k)=>i in u?ge(u,i,{enumerable:!0,configurable:!0,writable:!0,value:k}):u[i]=k;var C=(u,i,k)=>Me(u,typeof i!="symbol"?i+"":i,k);(function(){"use strict";function u(e){return new Worker("/avif2jpeg/dist/assets/worker.canvas-BFdG0mGm.js",{name:e==null?void 0:e.name})}let i=0;class k extends u{constructor(s){super();C(this,"id",i++);C(this,"priority");this.priority=s||!1}release(){b(this)}}class J extends Promise{constructor(){super(...arguments);C(this,"wid",-1)}}const L=new Set,h=new Set,m=new Set,M=new Map,G=[];function ee(e){const t=new k;return L.add(t),O(t,e),b(t),e&&G.push(t.id),t}function O(e,t){const s=t?m:h,n=new J(o=>{M.set(e,()=>o([e,n,!!t]))});n.wid=e.id,s.add(n)}async function te(e){let t;if(!e)t=new Set([...m,...h]);else if(typeof e=="number"){const c=G.slice(0,e);t=new Set([...m].filter(d=>c.includes(d.wid)))}else t=e?m:h;const[s,n,o]=await Promise.any(t);return(o?m:h).delete(n),O(s,o),s}function b(e){const t=M.get(e);t&&(M.delete(e),t(),p==null||p(),p=null)}function se(){for(const e of M.keys())b(e)}async function B(){return await Promise.all([...h,...m])}let U,p=null;async function ne(){p||(U=new Promise(e=>p=e)),await U}function oe(){se();for(const e of L)e.onmessage=null,e.terminate();L.clear(),h.clear(),m.clear(),M.clear(),i=0}function ae(e){return new Promise(t=>setTimeout(t,e))}const ie=1,P=2e3*2e3*5,re=5,ce=1,le=P*1,fe=P*6,de=100;let V,r;const E=new Map,X=new Map,A=new Map;let _=0,g=!1,Z=0,$=0;self.onmessage=async e=>{const{data:t,ports:s}=e,{action:n}=t;switch(n){case"set-zip-port":{V=s[0],self.postMessage({action:"respond-to-first-message"});break}case"start-convert":{const{list:o,fileIdList:c,outputType:d,outputQuality:W,threads:Y,maxSize:D}=t;o.forEach((v,N)=>v._id=c[N]),ue(o,d,W,Y,D);break}case"cancel-convert":g=!0;break}};async function ue(e,t,s,n,o){r=e;const c=Math.max(1,Math.min(n-3,r.length)),d=Math.min(re,c);me(c,d);const W=async()=>{for(let f=1;!g&&_>fe;f++){if(f>9999)throw new Error(`maybe totalChunkSize is deadlocked :${_}`);await ne()}},D=r.length===1;let v=0,N="",a=0;for(;a<r.length;){const f=[],R=[];let z=!1;const ke=r.length-a,he=Math.min(a+Math.max(Math.min(ce,ke/n|0),1),r.length);let y=0,F=!1;for(;a<he;a++){if(y>le&&!g){await W();break}const l=r[a],w=l._id,S=l.webkitRelativePath||l.name,pe=A.get(w);if(F=F||!!pe,z=a===r.length-1,Z++,I("file-start",a,S,w),g){I("file-canceled",a,S,w);continue}let T;try{T=await createImageBitmap(l)}catch{K(a,S,w);continue}if(await W(),g){I("file-canceled",a,S,w);continue}R.push(T);const q=T.width*T.height*4;y+=q+l.size,_+=q+l.size;let H=!1;const Q=Date.now();Q-v>de&&(v=Q,H=!0),f.push({index:a,bitmap:T,file:l,fileId:w,outputPath:N,type:t,quality:s/100,demandThumbnail:H||z,isSingleImage:D,maxSize:o,retriedTime:A.get(w)||0,webkitRelativePath:l.webkitRelativePath}),H=!1}let x;if(f.length){const l=y>P;x=await te(d>0&&(F?1:l)),E.set(x.id,y),x.postMessage(f,R),R.length=0}if(z&&(await B(),g))break}await B(),self.postMessage({action:"end-convert"});for(let f=0;Z!==$&&!(f>50);f++)await ae(100);self.close()}function me(e,t){oe();for(let s=0;s<e;s++){const n=ee(t>s);n.onmessage=we;const{port1:o,port2:c}=new MessageChannel;V.postMessage({action:"set-port-canvas"},[o]),n.postMessage({},[c])}}const we=e=>{const t=e.target,{data:s}=e,{action:n}=s;switch(n){case"file-load":s.workerId=t.id;case"file-converted":case"file-completed":case"file-canceled":{self.postMessage(s);break}case"file-error":{const{index:o,path:c,fileId:d}=s;K(o,c,d);break}case"list-end":{b(t),_-=E.get(t.id)||0,E.delete(t.id);break}}j(n)};function I(e,t,s,n){const o={action:e,index:t,path:s,fileId:n};self.postMessage(o),j(e)}function j(e){switch(e){case"file-completed":case"file-canceled":case"file-error":case"file-retry":$++;break}}function K(e,t,s){const n=r[e];if(!n)throw new Error(`the file doesn't exist. "${e}":"${t}"`);const o=X.get(n._id)||0;o<ie?(X.set(n._id,o+1),r.push(n),A.set(s,Date.now()),I("file-retry",e,t,s)):I("file-error",e,t,s)}})();
