var We=Object.defineProperty;var Te=(p,c,m)=>c in p?We(p,c,{enumerable:!0,configurable:!0,writable:!0,value:m}):p[c]=m;var L=(p,c,m)=>Te(p,typeof c!="symbol"?c+"":c,m);(function(){"use strict";function p(e){return new Worker("/avif2jpeg/dist/assets/worker.canvas-Ghwa7HbP.js",{name:e==null?void 0:e.name})}let c=0;class m extends p{constructor(s){super();L(this,"id",c++);L(this,"priority");this.priority=s||!1}release(){v(this)}}class ie extends Promise{constructor(){super(...arguments);L(this,"wid",-1)}}const _=new Set,h=new Set,w=new Set,b=new Map,G=[];function ne(e){const t=new m;return _.add(t),j(t,e),v(t),e&&G.push(t.id),t}function j(e,t){const s=t?w:h,o=new ie(r=>{b.set(e,()=>r([e,o,!!t]))});o.wid=e.id,s.add(o)}async function ae(e){let t;if(!e)t=new Set([...w,...h]);else if(typeof e=="number"){const i=G.slice(0,e);t=new Set([...w].filter(n=>i.includes(n.wid)))}else t=e?w:h;const[s,o,r]=await Promise.any(t);return(r?w:h).delete(o),j(s,r),s}function v(e){const t=b.get(e);t&&(b.delete(e),t(),g==null||g(),g=null)}function ce(){for(const e of b.keys())v(e)}async function U(){return await Promise.all([...h,...w])}let V,g=null;async function le(){g||(V=new Promise(e=>g=e)),await V}function fe(){ce();for(const e of _)e.onmessage=null,e.terminate();_.clear(),h.clear(),w.clear(),b.clear(),c=0}function de(e){return[..._].find(t=>t.id===e)}function ue(e){return new Promise(t=>setTimeout(t,e))}const pe=1,X=2e3*2e3*5,we=5,ke=1,me=X*6,he=100;let $,l;const y=new Map,Y=new Map,A=new Map,Z=new Set;let P=0,S=!1,q=0,K=0;self.onmessage=async e=>{const{data:t,ports:s}=e,{action:o}=t;switch(o){case"set-zip-port":{$=s[0],self.postMessage({action:"respond-to-first-message"});break}case"start-convert":{const{list:r,extraPropsForList:i,outputType:n,outputQuality:W,threads:F,maxSize:C,keepExt:E,outputExt:R,fsysDirHandler:ee,existingFolders:x}=t;r.forEach((M,D)=>{M._id=i[D][0],M.webkitRelativePath||Object.defineProperty(M,"webkitRelativePath",{value:i[D][1]})}),ge(r,n,W,F,R,E,C,ee,x);break}case"cancel-convert":S=!0;break;case"respond-overwrite":{const r=t.workerId;de(r).postMessage({action:"respond-overwrite",command:t.command,target:t.target,fileId:t.fileId,path:t.path});const n=t.skippedFolderPath;n&&Z.add(n+"/");break}}};async function ge(e,t,s,o,r,i,n,W,F){l=e;const C=Math.max(1,Math.min(o-3,l.length)),E=Math.min(we,C);Me(C,E,W,F);const R=async()=>{for(let f=1;!S&&P>me;f++){if(f>9999)throw new Error(`maybe totalChunkSize is deadlocked :${P}`);await le()}},x=l.length===1;let M=0,D="",a=0;for(;a<l.length;a++){const f=[];let z=!1;const be=l.length-a;Math.min(a+Math.max(Math.min(ke,be/o|0),1),l.length);let N=0,H=!1;const d=l[a],u=d._id,I=d.webkitRelativePath||d.name,ve=A.get(u);if(H=H||!!ve,z=a===l.length-1,q++,k("file-start",a,I,u),S){k("file-canceled",a,I,u);continue}let te=!1;for(const oe of Z)if(I.startsWith(oe)){k("file-skip",a,I,u),te=!0;break}if(te)continue;let T;try{T=await createImageBitmap(d)}catch{J(a,I,u);continue}if(await R(),S){k("file-canceled",a,I,u);continue}f.push(T);const se=T.width*T.height*4;N+=se+d.size,P+=se+d.size;let O=!1;const re=Date.now();re-M>he&&(M=re,O=!0);const ye={index:a,bitmap:T,file:d,fileId:u,outputPath:D,type:t,quality:s/100,keepPrevExt:i,outputExt:r,demandThumbnail:O||z,isSingleImage:x,maxSize:n,retriedTime:A.get(u)||0,webkitRelativePath:d.webkitRelativePath.replace(/^\//,"")};O=!1;let B;const Pe=N>X;B=await ae(E>0&&(H?1:Pe)),y.set(B.id,N),B.postMessage(ye,f),f.length=0,z&&await U()}await U(),self.postMessage({action:"end-convert"});for(let f=0;q!==K&&!(f>50);f++)await ue(100);self.postMessage({action:"close-loader"}),self.close()}function Me(e,t,s,o){fe();for(let r=0;r<e;r++){const i=ne(t>r);i.onmessage=Ie;const{port1:n,port2:W}=new MessageChannel;$.postMessage({action:"set-port-canvas"},[n]),i.postMessage({port:"zip",fsysDirHandler:s,existingFolders:o},[W])}}const Ie=async e=>{const t=e.target,{data:s}=e,{action:o}=s;switch(o){case"file-load":s.workerId=t.id;case"file-canceled":{self.postMessage(s);break}case"file-converted":{const{convertedImageBlob:r,path:i}=s;self.postMessage(s);break}case"file-completed":case"file-sys-completed":{v(t),P-=y.get(t.id)||0,y.delete(t.id),self.postMessage(s);break}case"file-skip":case"file-error":{const{index:r,path:i,fileId:n}=s;v(t),P-=y.get(t.id)||0,y.delete(t.id),o==="file-error"?J(r,i,n):k("file-skip",r,i,n);return}case"list-start":case"list-end":case"respond-to-first-message":break;case"confirm-overwrite":self.postMessage({...s,workerId:t.id});return}Q(o)};function k(e,t,s,o){const r={action:e,index:t,path:s,fileId:o};self.postMessage(r),Q(e)}function Q(e){switch(e){case"file-completed":case"file-sys-completed":case"file-canceled":case"file-error":case"file-skip":case"file-retry":K++;break}}function J(e,t,s){const o=l[e];if(!o)throw new Error(`the file doesn't exist. "${e}":"${t}"`);const r=Y.get(o._id)||0;r<pe?(Y.set(o._id,r+1),l.push(o),A.set(s,Date.now()),k("file-retry",e,t,s)):k("file-error",e,t,s)}})();
