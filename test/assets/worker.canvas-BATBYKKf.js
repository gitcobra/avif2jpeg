(function(){"use strict";console.log("running converter.worker.canvas");const w=new OffscreenCanvas(100,100),x=w.getContext("bitmaprenderer");let d;const z=new Map;self.onmessage=async r=>{const{ports:e}=r;if(e[0]){d=e[0],d.onmessage=T;return}const n=r.data;for(const t of n)await P(t);self.postMessage({action:"list-end"})};async function P(r){const{index:e,file:n,fileId:t,type:g,quality:m,demandThumbnail:p,isSingleImage:v,webkitRelativePath:u,maxSize:f}=r,o=u||n.webkitRelativePath||n.name,b=n.size;let i;i={action:"file-start",path:o,fileId:t,index:e},self.postMessage(i);let c,a,s;try{if(c=await createImageBitmap(n),{width:a,height:s}=c,f){const l=a/s;let{width:B,height:k}=f,h={};a>B&&(a=B,s=a/l,h={resizeWidth:a}),s>k&&(s=k,a=s*l,h={resizeHeight:s}),c=await createImageBitmap(c,{resizeQuality:"high",...h})}}catch{console.error("error occurred on canvas worker",t,o),i={action:"file-error",path:o,fileId:t,index:e},self.postMessage(i);return}let M=null;if(p){const l=a>s?{resizeWidth:110}:{resizeHeight:80};M=await createImageBitmap(c,{...l,resizeQuality:"low"})}x.transferFromImageBitmap(c),i={action:"file-load",fileId:t,path:o,index:e,thumbnail:M,width:a,height:s},self.postMessage(i);const y=await w.convertToBlob({type:g,quality:m}),I=y.size;d.postMessage({blob:y,path:o,fileId:t}),i={action:"file-converted",path:o,fileId:t,index:e,outputsize:I,inputsize:b,width:a,height:s},self.postMessage(i),z.set(t,{outputsize:I,inputsize:b,path:o,index:e})}const T=r=>{const{fileId:e,renamed:n,outputPath:t,canceled:g}=r.data,{inputsize:m,outputsize:p,path:v,index:u}=z.get(e),f={action:g?"file-canceled":"file-completed",fileId:e,path:v,index:u,inputsize:m,outputsize:p};self.postMessage(f)}})();
