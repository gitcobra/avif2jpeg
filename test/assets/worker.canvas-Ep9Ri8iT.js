(function(){"use strict";console.log("running converter.worker.canvas");const b=new OffscreenCanvas(100,100),P=b.getContext("bitmaprenderer");let m;const v=new Map;self.onmessage=async r=>{const{ports:e}=r;if(e[0]){m=e[0],m.onmessage=R;return}const o=r.data;for(const t of o)await T(t);self.postMessage({action:"list-end"})};async function T(r){const{index:e,file:o,fileId:t,type:d,quality:g,demandThumbnail:p,demandImage:u,webkitRelativePath:h,maxSize:f}=r,n=h||o.webkitRelativePath||o.name,M=o.size;let i;i={action:"file-start",path:n,fileId:t,index:e},self.postMessage(i);let c,a,s;try{if(c=await createImageBitmap(o),{width:a,height:s}=c,f){const l=a/s;let{width:k,height:x}=f,z={};a>k&&(a=k,s=a/l,z={resizeWidth:a}),s>x&&(s=x,a=s*l,z={resizeHeight:s}),c=await createImageBitmap(c,{resizeQuality:"high",...z})}}catch{console.error("error occurred on canvas worker",t,n),i={action:"file-error",path:n,fileId:t,index:e},self.postMessage(i);return}let y=null;if(p){const l=a>s?{resizeWidth:110}:{resizeHeight:80};y=await createImageBitmap(c,{...l,resizeQuality:"low"})}P.transferFromImageBitmap(c),i={action:"file-load",fileId:t,path:n,index:e,thumbnail:y,width:a,height:s},self.postMessage(i);const w=await b.convertToBlob({type:d,quality:g}),B=w.size;let I;u?I=w:m.postMessage({blob:w,path:n,fileId:t}),i={action:"file-converted",path:n,fileId:t,index:e,outputsize:B,inputsize:M,image:I,width:a,height:s},self.postMessage(i),v.set(t,{outputsize:B,inputsize:M,path:n,index:e})}const R=r=>{const{fileId:e,renamed:o,outputPath:t,canceled:d}=r.data,{inputsize:g,outputsize:p,path:u,index:h}=v.get(e),f={action:d?"file-canceled":"file-completed",fileId:e,path:u,index:h,inputsize:g,outputsize:p};self.postMessage(f)}})();
